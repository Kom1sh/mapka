<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мапка - Найди кружок для ребёнка</title>
  <link rel="canonical" href="https://xn--80aa3agq.xn--p1ai/">
  <meta name="description" content="Поиск детских кружков и секций на карте">
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- Подключаем Яндекс Карты API v3 -->
  <script src="https://api-maps.yandex.ru/v3/?apikey=58c38b72-57f7-4946-bc13-a256d341281a&lang=ru_RU"></script>
  <script src="map.js" defer></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* removed dark theme variables, keeping only light theme */
    :root {
      --bg-primary: #f5f5f5;
      --bg-secondary: white;
      --bg-card: #d1d1d1;
      --bg-input: white;
      --text-primary: #1a1a1a;
      --text-secondary: #565555;
      --border-color: #e5e5e5;
      --handle-color: #d1d1d1;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #565555;
      color: white;
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      height: 56px;
      gap: 16px;
    }

    .logo {
      height: 32px;
      font-size: 24px;
      font-weight: bold;
      color: white;
      text-decoration: none;
    }

    .nav-desktop {
      display: none;
      align-items: center;
      gap: 20px;
      margin-right: auto;
    }

    .nav-desktop a {
      color: white;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .nav-desktop a:hover {
      opacity: 0.8;
    }

    .header-right-desktop {
      display: none;
      align-items: center;
      gap: 24px;
    }

    .header-right-desktop a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-right-mobile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
    }

    .icon-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Menu */
    .mobile-menu-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
    }

    .mobile-menu-overlay.active {
      display: block;
    }

    .mobile-menu {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      width: 288px;
      background: #565555;
      color: white;
      z-index: 101;
      transform: translateX(100%);
      transition: transform 0.3s;
    }

    .mobile-menu.active {
      transform: translateX(0);
    }

    .mobile-menu-header {
      display: flex;
      justify-content: flex-end;
      padding: 16px;
    }

    .mobile-menu-content {
      padding: 24px;
    }

    .mobile-menu-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 24px;
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #888;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-menu nav {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mobile-menu nav a {
      color: white;
      text-decoration: none;
    }

    /* Main Layout */
    .main-desktop {
      display: none;
      position: relative;
      height: calc(100vh - 64px);
    }

    .map-container {
      position: absolute;
      inset: 0;
      background: #e5e5e5;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* updated left-panel to support collapsing */
    .left-panel {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 800px;
      max-width: 50%;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 16px;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .left-panel.collapsed {
      transform: translateX(calc(-100% + 24px));
    }

    /* Внешний контейнер с рамкой и скруглением */
    .cards-container {
      flex: 1;
      background: var(--bg-secondary);
      border-radius: 24px;
      border: 2px solid #1a1a1a;
      position: relative;
      overflow: hidden;         /* обрезаем скролл по радиусу */
    }

    /* Внутренний блок, который реально скроллится */
    .cards-scroll {
      height: 100%;
      padding: 16px;
      overflow-y: auto;
    }

    /* Кастомный скроллбар для desktop */
    .cards-scroll::-webkit-scrollbar {
      width: 10px;
    }

    .cards-scroll::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 12px;
      margin: 8px;
    }

    .cards-scroll::-webkit-scrollbar-thumb {
      background: #69AFDF;
      border-radius: 12px;
      border: 3px solid var(--bg-secondary);
    }

    .cards-scroll::-webkit-scrollbar-thumb:hover {
      background: #5a9fcf;
    }

    /* Firefox */
    .cards-scroll {
      scrollbar-width: thin;
      scrollbar-color: #69AFDF var(--bg-primary);
    }


    /* Add custom scrollbar styling for desktop cards container */
    .cards-container::-webkit-scrollbar {
      width: 12px;
    }

    .cards-container::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 12px;
      margin: 8px;
    }

    .cards-container::-webkit-scrollbar-thumb {
      background: #69AFDF;
      border-radius: 12px;
      border: 3px solid var(--bg-secondary);
    }

    .cards-container::-webkit-scrollbar-thumb:hover {
      background: #5a9fcf;
    }

    /* Firefox scrollbar styling */
    .cards-container {
      scrollbar-width: thin;
      scrollbar-color: #69AFDF var(--bg-primary);
    }

    /* added desktop panel handle for collapsing */
    .desktop-panel-handle {
      position: absolute;
      right: -24px;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      background: var(--bg-secondary);
      border: 2px solid #1a1a1a;
      border-left: none;
      border-radius: 0 12px 12px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 11;
      transition: background 0.2s;
    }

    .desktop-panel-handle:hover {
      background: var(--bg-card);
    }

    .desktop-panel-handle svg {
      width: 16px;
      height: 16px;
      color: var(--text-primary);
      transition: transform 0.3s;
    }

    .left-panel.collapsed .desktop-panel-handle svg {
      transform: rotate(180deg);
    }

    .cards-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Search Filter */
    .search-filter {
      display: flex;
      gap: 8px;
      height: 40px;
    }

    .filter-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px;
      background: #69AFDF;
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .filter-btn:hover {
      transform: scale(1.02);
    }

    /* Mobile filter button - icon only */
    .filter-btn .filter-text {
      display: none;
    }

    .search-box {
      flex: 1;
      display: flex;
      background: #69AFDF;
      border-radius: 24px;
      padding: 2px;
    }

    .search-box input {
      flex: 1;
      min-width: 0;
      background: var(--bg-input);
      color: var(--text-primary);
      border: none;
      border-radius: 24px;
      padding: 0 16px;
      font-size: 14px;
      outline: none;
    }

    .search-box button {
      padding: 0 16px;
      background: none;
      border: none;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    .search-box .search-btn-mobile {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
    }

    .search-box .search-btn-mobile svg {
      width: 20px;
      height: 20px;
    }

    .search-box .search-btn-text {
      display: none;
    }

    /* Club Card */
    .club-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sectionCard {
      transition: box-shadow 0.3s;
    }

    .sectionCard.highlight-temp {
      box-shadow: 0 0 0 3px #69AFDF;
    }

    .card-top {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-image {
      position: relative;
      width: 100%;
      height: 180px;
      border-radius: 16px;
      overflow: hidden;
      flex-shrink: 0;
      background: #ccc;
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .favorite-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .favorite-btn svg {
      width: 24px;
      height: 24px;
      color: white;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }

    .favorite-btn.active svg {
      fill: #ef4444;
      color: #ef4444;
    }

    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    .card-title {
      background: var(--bg-input);
      color: var(--text-primary);
      border-radius: 16px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: normal;
    }

    .card-description {
      background: var(--bg-input);
      color: var(--text-primary);
      border-radius: 16px;
      padding: 8px 12px;
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.5;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag-btn {
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-btn:hover {
      background: #69AFDF;
      color: white;
    }

    .tag-btn.active {
      background: #69AFDF;
      color: white;
    }

    .card-bottom {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-location {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--text-primary);
    }

    .card-location svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .card-buttons {
      display: flex;
      gap: 8px;
    }

    .card-btn {
      background: #69AFDF;
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.2s;
      text-decoration: none;
    }

    .card-btn:hover {
      transform: scale(1.02);
    }

    .card-price {
      background: var(--bg-input);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .card-price.free {
      background: #4ade80;
      color: white;
    }

    /* Mobile Layout */
    .main-mobile {
      display: block;
    }

    .mobile-map {
      position: fixed;
      inset: 0;
      top: 56px;
      z-index: 0;
      background: #e5e5e5;
      transition: height 0.3s;
    }

    #mobileMap {
      width: 100%;
      height: 100%;
    }

    /* updated Bottom Sheet with black border */
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-secondary);
      border-radius: 24px 24px 0 0;
      border: 2px solid #1a1a1a;
      border-bottom: none;
      z-index: 30;
      touch-action: none;
      transition: transform 0.3s ease-out;
      max-height: calc(100vh - 56px);
      top: 56px;
    }

    .bottom-sheet.peek {
      transform: translateY(calc(100% - 84px));
    }

    .bottom-sheet.split {
      transform: translateY(50%);
    }

    .bottom-sheet.full {
      transform: translateY(0);
    }

    .sheet-handle {
      display: flex;
      justify-content: center;
      padding: 12px;
      cursor: grab;
    }

    .handle-bar {
      width: 48px;
      height: 4px;
      background: var(--handle-color);
      border-radius: 2px;
    }

    /* Sheet header for filter/search buttons */
    .sheet-header {
      display: flex;
      gap: 8px;
      padding: 0 16px 12px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 12px;
    }

    .sheet-header .search-filter {
      flex: 1;
    }

    .sheet-content {
      padding: 0 16px 24px;
      overflow-y: auto;
      max-height: calc(100vh - 56px - 40px - 80px);
    }

    .sheet-cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    /* Filter Panel Styles */
    .filter-panel {
      display: none;
      position: fixed;
      inset: 0;
      top: 56px;
      background: var(--bg-secondary);
      z-index: 40;
      flex-direction: column;
      overflow-y: auto;
    }

    .filter-panel.active {
      display: flex;
    }

    .filter-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      background: var(--bg-secondary);
      z-index: 1;
    }

    .filter-panel-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .filter-panel-content {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .filter-section {
      margin-bottom: 24px;
    }

    .filter-section h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-secondary);
    }

    /* Tag search input with autocomplete */
    .tag-search-container {
      position: relative;
      margin-bottom: 12px;
    }

    .tag-search-input {
      width: 100%;
      padding: 10px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      background: var(--bg-input);
      color: var(--text-primary);
      outline: none;
    }

    .tag-search-input:focus {
      border-color: #69AFDF;
    }

    .tag-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .tag-suggestions.active {
      display: block;
    }

    .tag-suggestion-item {
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.2s;
      color: var(--text-primary);
    }

    .tag-suggestion-item:hover {
      background: var(--bg-card);
    }

    .tag-suggestion-item.selected {
      background: #69AFDF;
      color: white;
    }

    /* Tags container with expand/collapse */
    .filter-tags-wrapper {
      position: relative;
    }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      overflow: hidden;
      max-height: 120px;
      transition: max-height 0.3s ease;
    }

    .filter-tags.expanded {
      max-height: 2000px;
    }

    /* updated filter-tag to have same hover effect as card tags */
    .filter-tag {
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 24px;
      border: 1px solid #1a1a1a;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tag:hover {
      background: #69AFDF;
      color: white;
      border-color: #69AFDF;
    }

    .filter-tag.active {
      background: #69AFDF;
      color: white;
      border-color: #69AFDF;
    }

    .tags-expand-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 12px;
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .tags-expand-btn:hover {
      border-color: #69AFDF;
      color: #69AFDF;
    }

    .tags-expand-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.3s;
    }

    .tags-expand-btn.expanded svg {
      transform: rotate(180deg);
    }

    /* Price Slider Styles */
    .price-slider-container {
      padding: 8px 0;
    }

    .price-range-labels {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .price-slider {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, #69AFDF 0%, #69AFDF var(--slider-percent, 50%), var(--border-color) var(--slider-percent, 50%), var(--border-color) 100%);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    .price-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #69AFDF;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .price-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #69AFDF;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .price-current {
      text-align: center;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .filter-panel-footer {
      padding: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      position: sticky;
      bottom: 0;
      background: var(--bg-secondary);
    }

    .filter-reset-btn {
      flex: 1;
      padding: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: none;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .filter-apply-btn {
      flex: 2;
      padding: 12px;
      background: #69AFDF;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Active filters indicator */
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .active-filter-chip {
      display: flex;
      align-items: center;
      gap: 4px;
      background: #69AFDF;
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 16px;
    }

    .active-filter-chip button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
    }

    /* Desktop styles */
    @media (min-width: 768px) {
      .header-inner {
        padding: 0 40px;
        height: 64px;
      }

      .logo {
        height: 40px;
      }

      .nav-desktop {
        display: flex;
      }

      .header-right-desktop {
        display: flex;
      }

      .header-right-mobile {
        display: none;
      }

      .main-desktop {
        display: block;
      }

      .main-mobile {
        display: none;
      }

      .search-filter {
        height: 72px;
      }

      .filter-btn {
        padding: 0 56px 0 40px;
        font-size: 20px;
      }

      /* Show filter text on desktop */
      .filter-btn .filter-text {
        display: inline;
      }

      .search-box {
        padding: 4px;
      }

      .search-box input {
        padding: 0 24px;
        font-size: 20px;
      }

      .search-box button {
        padding: 0 32px;
        font-size: 20px;
      }

      .search-box .search-btn-text {
        display: block;
      }

      .search-box .search-btn-mobile {
        display: none;
      }

      /* Desktop: image on side, not above */
      .card-top {
        flex-direction: row;
      }

      .card-image {
        width: 250px;
        height: 250px;
        border-radius: 24px;
      }

      .card-title {
        border-radius: 24px;
        padding: 8px 24px;
        font-size: 24px;
      }

      .card-description {
        border-radius: 24px;
        padding: 16px;
        font-size: 16px;
      }

      .card-tags {
        gap: 8px;
      }

      .tag-btn {
        font-size: 14px;
        padding: 4px 12px;
      }

      .card-bottom {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .card-location {
        font-size: 16px;
        order: 2;
      }

      .card-location svg {
        width: 24px;
        height: 24px;
      }

      .card-buttons {
        order: 1;
      }

      .card-btn {
        padding: 8px 16px;
        border-radius: 24px;
        font-size: 16px;
      }

      .card-price {
        font-size: 14px;
        padding: 8px 16px;
      }

      /* Desktop filter panel */
      .filter-panel {
        position: absolute;
        left: 16px;
        top: 100px;
        right: auto;
        bottom: auto;
        width: 400px;
        max-height: calc(100vh - 180px);
        border-radius: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        inset: auto;
      }
    }
  </style>
  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
      (function(m,e,t,r,i,k,a){
          m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
          m[i].l=1*new Date();
          for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
          k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
      })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105798797', 'ym');
  
      ym(105798797, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/105798797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="logoContainer">
         <img src="logo.svg" alt="Мапка" class="mainLogo">
      </div>

      <nav class="nav-desktop">
        <a href="#">Все категории</a>
        <a href="#">Новости</a>
        <a href="#">Помощь</a>
      </nav>

      <div class="header-right-desktop">
        <!-- removed theme toggle button from desktop header -->
        <button class="icon-btn" aria-label="Избранное">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
          </svg>
        </button>
        <a href="#">
          <span>Профиль</span>
          <div class="avatar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="24" height="24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
            </svg>
          </div>
        </a>
        <a href="#">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          <span>Ростов-на-Дону</span>
        </a>
      </div>

      <div class="header-right-mobile">
        <!-- removed theme toggle button from mobile header -->
        <button class="icon-btn" aria-label="Избранное">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
          </svg>
        </button>
        <button class="icon-btn" id="menuBtn" aria-label="Меню">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="menuOverlay"></div>
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-header">
      <button class="icon-btn" id="closeMenuBtn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="mobile-menu-content">
      <div class="mobile-menu-profile">
        <div class="avatar">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="32" height="32">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
          </svg>
        </div>
        <div>
          <p style="font-weight: 500;">Профиль</p>
          <p style="font-size: 14px; opacity: 0.8;">Ростов-на-Дону</p>
        </div>
      </div>
      <nav>
        <a href="#">Все категории</a>
        <a href="#">Новости</a>
        <a href="#">Помощь</a>
        <a href="#">Избранное</a>
      </nav>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" id="filterPanel">
    <div class="filter-panel-header">
      <h2>Фильтры</h2>
      <button class="icon-btn" id="closeFilterBtn" style="color: var(--text-primary);">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="filter-panel-content">
      <div class="filter-section">
        <h3>Теги</h3>
        <!-- Tag search input with autocomplete -->
        <div class="tag-search-container">
          <input type="text" class="tag-search-input" id="tagSearchInput" placeholder="Введите название тега...">
          <div class="tag-suggestions" id="tagSuggestions"></div>
        </div>
        <!-- Tags with expand/collapse functionality -->
        <div class="filter-tags-wrapper">
          <div class="filter-tags" id="filterTags">
            <!-- Tags will be populated dynamically -->
          </div>
          <button class="tags-expand-btn" id="tagsExpandBtn">
            <span class="expand-text">Показать все</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
        </div>
      </div>
      <div class="filter-section">
        <h3>Цена за занятие</h3>
        <div class="price-slider-container">
          <div class="price-range-labels">
            <span>Бесплатно</span>
            <span id="maxPriceLabel">5000 ₽</span>
          </div>
          <input type="range" class="price-slider" id="priceSlider" min="0" max="5000" value="5000" step="100">
          <div class="price-current">До <span id="currentPriceValue">5000</span> ₽</div>
        </div>
      </div>
    </div>
    <div class="filter-panel-footer">
      <button class="filter-reset-btn" id="filterResetBtn">Сбросить</button>
      <button class="filter-apply-btn" id="filterApplyBtn">Применить</button>
    </div>
  </div>

  <!-- Desktop Layout -->
  <main class="main-desktop">
    <div class="map-container">
      <div id="map"></div>
    </div>

    <div class="left-panel" id="leftPanel">
      <div class="search-filter">
        <button class="filter-btn" id="desktopFilterBtn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
          </svg>
          <span class="filter-text">Фильтры</span>
        </button>
        <div class="search-box">
          <input type="search" placeholder="поиск кружка!" id="desktopSearchInput">
          <button type="submit" class="search-btn-text" id="desktopSearchBtn">Найти</button>
          <button type="submit" class="search-btn-mobile" id="desktopSearchBtnMobile">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
          </button>
        </div>
      </div>

      <div class="active-filters" id="desktopActiveFilters"></div>

      <div class="desktop-panel-handle" id="desktopPanelHandle">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" />
        </svg>
      </div>
      <div class="cards-container">
        <div class="cards-scroll">
          <div class="cards-list" id="desktopCards"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Mobile Layout -->
  <main class="main-mobile">
    <div class="mobile-map">
      <div id="mobileMap"></div>
    </div>

    <div class="bottom-sheet split" id="bottomSheet">
      <div class="sheet-handle" id="sheetHandle">
        <div class="handle-bar"></div>
      </div>
      <!-- Sheet header with filter and search buttons -->
      <div class="sheet-header">
        <div class="search-filter">
          <button class="filter-btn" id="mobileFilterBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
            </svg>
          </button>
          <div class="search-box">
            <input type="search" placeholder="поиск кружка!" id="mobileSearchInput">
            <button type="submit" class="search-btn-mobile" id="mobileSearchBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="sheet-content">
        <div class="active-filters" id="mobileActiveFilters"></div>
        <div class="sheet-cards" id="mobileCards"></div>
      </div>
    </div>
  </main>

  <script>
    let filterState = {
      selectedTags: [],
      maxPrice: 5000,
      searchQuery: ''
    };

    let allTags = [];
    let allClubs = [];
    let maxPriceFromDB = 5000;
    let tagsExpanded = false;
    let desktopPanelCollapsed = false;

    const API_BASE = (function(){
      try {
        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
          return "http://localhost:8000/api";
        }
        return `${location.protocol}//${location.host}/api`;
      } catch(e) {
        return "http://localhost:8000/api";
      }
    })();

    function formatPrice(priceCents) {
      if (priceCents === null || priceCents === undefined || priceCents === 0) {
        return { text: 'Бесплатно', isFree: true };
      }
      const priceRub = Math.round(priceCents / 100);
      return { text: `${priceRub.toLocaleString('ru-RU')} ₽`, isFree: false };
    }

    function createCardHTML(club) {
      const price = formatPrice(club.price_cents);
      return `
        <div class="club-card sectionCard" data-tags="${(club.tags || []).join(',').toLowerCase()}" data-price="${club.price_cents || 0}">
          <div class="card-top">
            <div class="card-image">
              <img src="${club.image}" alt="${club.name}">
              <button class="favorite-btn ${club.isFavorite ? 'active' : ''}" data-id="${club.id}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                </svg>
              </button>
            </div>
            <div class="card-content">
              <h2 class="card-title">${club.name}</h2>
              <div class="card-description">${club.description}</div>
            </div>
          </div>
          <div class="card-tags">
            ${(club.tags || []).map(tag => `<button class="tag-btn" data-tag="${tag.toLowerCase()}">${tag}</button>`).join('')}
          </div>
          <div class="card-bottom">
            <div class="card-location">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
              </svg>
              <span class="cardLocationText">${club.location}</span>
            </div>
            <span class="card-price ${price.isFree ? 'free' : ''}">${price.text}</span>
            <div class="card-buttons">
              <a href="/${encodeURIComponent(club.slug)}" class="card-btn">Подробнее</a>
            </div>
          </div>
        </div>
      `;
    }

    window.createCardHTML = createCardHTML;

    function initFilters(clubsData) {
      allClubs = clubsData;
      
      const tagSet = new Set();
      let maxPrice = 0;
      
      clubsData.forEach(club => {
        (club.tags || []).forEach(tag => tagSet.add(tag.toLowerCase()));
        const priceCents = club.price_cents || 0;
        const priceRub = Math.round(priceCents / 100);
        if (priceRub > maxPrice) maxPrice = priceRub;
      });
      
      allTags = Array.from(tagSet).sort();
      maxPriceFromDB = maxPrice > 0 ? maxPrice : 5000;
      
      const priceSlider = document.getElementById('priceSlider');
      const maxPriceLabel = document.getElementById('maxPriceLabel');
      const currentPriceValue = document.getElementById('currentPriceValue');
      
      priceSlider.max = maxPriceFromDB;
      priceSlider.value = maxPriceFromDB;
      filterState.maxPrice = maxPriceFromDB;
      maxPriceLabel.textContent = `${maxPriceFromDB.toLocaleString('ru-RU')} ₽`;
      currentPriceValue.textContent = maxPriceFromDB.toLocaleString('ru-RU');
      updateSliderBackground(priceSlider);
      
      renderFilterTags();
    }

    // Fetch clubs data from API
    async function fetchClubs(query = '', tags = [], maxPrice = null) {
      let url = `${API_BASE}/clubs/`;
      const params = [];
      if (query) params.push(`search=${encodeURIComponent(query)}`);
      if (tags.length > 0) params.push(`tags=${encodeURIComponent(tags.join(','))}`);
      if (maxPrice !== null && maxPrice > 0) params.push(`max_price_cents=${maxPrice * 100}`);

      if (params.length > 0) {
        url += `?${params.join('&')}`;
      }

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error fetching clubs:", error);
        return [];
      }
    }

    async function loadClubsAndInitFilters() {
      const clubs = await fetchClubs();
      initFilters(clubs);
      renderCards(clubs);
    }

    function renderCards(clubsData) {
      document.getElementById('desktopCards').innerHTML = clubsData.map(createCardHTML).join('');
      document.getElementById('mobileCards').innerHTML = clubsData.map(createCardHTML).join('');
    }

    window.initFilters = initFilters;

    function updateSliderBackground(slider) {
      const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
      slider.style.setProperty('--slider-percent', percent + '%');
    }

    function applyFilters() {
      const searchQuery = filterState.searchQuery.toLowerCase();
      const selectedTags = filterState.selectedTags;
      const maxPriceRub = filterState.maxPrice;

      // Fetch filtered clubs from API
      fetchClubs(searchQuery, selectedTags, maxPriceRub)
        .then(filteredClubs => {
          renderCards(filteredClubs);
          updateActiveFiltersDisplay();
        })
        .catch(error => {
          console.error("Error applying filters:", error);
          renderCards([]); // Clear cards if error
        });
    }

    function updateActiveFiltersDisplay() {
      ['desktopActiveFilters', 'mobileActiveFilters'].forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;

        let html = '';

        filterState.selectedTags.forEach(tag => {
          html += `
            <div class="active-filter-chip">
              ${tag}
              <button onclick="removeTagFilter('${tag}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          `;
        });

        if (filterState.maxPrice < maxPriceFromDB) {
          html += `
            <div class="active-filter-chip">
              До ${filterState.maxPrice.toLocaleString('ru-RU')} ₽
              <button onclick="removePriceFilter()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          `;
        }

        container.innerHTML = html;
      });
    }

    function removeTagFilter(tag) {
      filterState.selectedTags = filterState.selectedTags.filter(t => t !== tag);
      document.querySelectorAll(`.filter-tag[data-tag="${tag}"]`).forEach(btn => {
        btn.classList.remove('active');
      });
      applyFilters();
    }
    window.removeTagFilter = removeTagFilter;

    function removePriceFilter() {
      filterState.maxPrice = maxPriceFromDB;
      const priceSlider = document.getElementById('priceSlider');
      const currentPriceValue = document.getElementById('currentPriceValue');
      priceSlider.value = maxPriceFromDB;
      currentPriceValue.textContent = maxPriceFromDB.toLocaleString('ru-RU');
      updateSliderBackground(priceSlider);
      applyFilters();
    }
    window.removePriceFilter = removePriceFilter;

    // Old static render removed:
    // document.getElementById('desktopCards').innerHTML = clubs.map(createCardHTML).join('');
    // document.getElementById('mobileCards').innerHTML = clubs.map(createCardHTML).join('');
    // initFilters(clubs);

    async function loadClubsFromAPI() {
      try {
        const res = await fetch(`${API_BASE}/clubs`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const clubsData = await res.json();
        
        // Normalize data from API to match expected format
        const normalizedClubs = clubsData.map(c => {
          // Handle image URL - make absolute if relative
          let img = c.image || c.main_image_url || '';
          if (img && img.startsWith('/')) {
            const origin = location.hostname === 'localhost' || location.hostname === '127.0.0.1'
              ? 'http://localhost:8000'
              : `${location.protocol}//${location.host}`;
            img = origin + img;
          }
          
          return {
            id: c.id,
            name: c.name || '',
            slug: c.slug || c.id,
            description: c.description || '',
            image: img || 'https://via.placeholder.com/400x400?text=No+image',
            location: c.location || '',
            isFavorite: c.isFavorite || false,
            tags: c.tags || [],
            price_cents: c.price_cents || null
          };
        });
        
        return normalizedClubs;
      } catch (err) {
        console.error('Failed to load clubs from API:', err);
        return [];
      }
    }

    (async function initPage() {
      // Show loading state
      const desktopCards = document.getElementById('desktopCards');
      const mobileCards = document.getElementById('mobileCards');
      
      if (desktopCards) desktopCards.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Загрузка кружков...</div>';
      if (mobileCards) mobileCards.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Загрузка кружков...</div>';
      
      // Load data from API
      const clubs = await loadClubsFromAPI();
      
      if (clubs.length === 0) {
        const emptyMsg = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Кружки не найдены или ошибка загрузки</div>';
        if (desktopCards) desktopCards.innerHTML = emptyMsg;
        if (mobileCards) mobileCards.innerHTML = emptyMsg;
        return;
      }
      
      // Render cards
      if (desktopCards) desktopCards.innerHTML = clubs.map(createCardHTML).join('');
      if (mobileCards) mobileCards.innerHTML = clubs.map(createCardHTML).join('');
      
      // Initialize filters with actual data from API
      initFilters(clubs);
    })();

    // Mobile menu toggle
    const menuBtn = document.getElementById('menuBtn');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    const menuOverlay = document.getElementById('menuOverlay');
    const mobileMenu = document.getElementById('mobileMenu');

    function openMenu() {
      menuOverlay.classList.add('active');
      mobileMenu.classList.add('active');
    }

    function closeMenu() {
      menuOverlay.classList.remove('active');
      mobileMenu.classList.remove('active');
    }

    menuBtn.addEventListener('click', openMenu);
    closeMenuBtn.addEventListener('click', closeMenu);
    menuOverlay.addEventListener('click', closeMenu);

    const filterPanel = document.getElementById('filterPanel');
    const closeFilterBtn = document.getElementById('closeFilterBtn');
    const desktopFilterBtn = document.getElementById('desktopFilterBtn');
    const mobileFilterBtn = document.getElementById('mobileFilterBtn');
    const filterResetBtn = document.getElementById('filterResetBtn');
    const filterApplyBtn = document.getElementById('filterApplyBtn');

    function openFilterPanel() {
      filterPanel.classList.add('active');
      // Ensure filter panel content is scrollable if needed
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeFilterPanel() {
      filterPanel.classList.remove('active');
      document.body.style.overflow = ''; // Restore background scrolling
    }

    desktopFilterBtn?.addEventListener('click', openFilterPanel);
    mobileFilterBtn?.addEventListener('click', openFilterPanel);
    closeFilterBtn?.addEventListener('click', closeFilterPanel);

    const tagSearchInput = document.getElementById('tagSearchInput');
    const tagSuggestions = document.getElementById('tagSuggestions');

    tagSearchInput?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      
      if (!query) {
        tagSuggestions.classList.remove('active');
        return;
      }

      const matchingTags = allTags.filter(tag => 
        tag.includes(query) && !filterState.selectedTags.includes(tag)
      );

      if (matchingTags.length === 0) {
        tagSuggestions.classList.remove('active');
        return;
      }

      tagSuggestions.innerHTML = matchingTags.slice(0, 10).map(tag => 
        `<div class="tag-suggestion-item" data-tag="${tag}">${tag}</div>`
      ).join('');
      tagSuggestions.classList.add('active');
    });

    tagSearchInput?.addEventListener('blur', () => {
      // Delay hiding to allow click on suggestion
      setTimeout(() => {
        tagSuggestions.classList.remove('active');
      }, 200);
    });

    tagSuggestions?.addEventListener('click', (e) => {
      const item = e.target.closest('.tag-suggestion-item');
      if (!item) return;

      const tag = item.dataset.tag;
      if (tag && !filterState.selectedTags.includes(tag)) {
        filterState.selectedTags.push(tag);
        document.querySelectorAll(`.filter-tag[data-tag="${tag}"]`).forEach(btn => {
          btn.classList.add('active');
        });
      }

      tagSearchInput.value = '';
      tagSuggestions.classList.remove('active');
      // Apply filter immediately after selecting a tag from suggestions
      applyFilters();
    });

    const tagsExpandBtn = document.getElementById('tagsExpandBtn');
    const filterTagsContainer = document.getElementById('filterTags');

    function renderFilterTags() {
      filterTagsContainer.innerHTML = allTags.map(tag => 
        `<button class="filter-tag" data-tag="${tag}">${tag}</button>`
      ).join('');
    }

    tagsExpandBtn?.addEventListener('click', () => {
      tagsExpanded = !tagsExpanded;
      filterTagsContainer.classList.toggle('expanded', tagsExpanded);
      tagsExpandBtn.classList.toggle('expanded', tagsExpanded);
      tagsExpandBtn.querySelector('.expand-text').textContent = tagsExpanded ? 'Свернуть' : 'Показать все';
    });

    document.getElementById('filterTags')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.filter-tag');
      if (!btn) return;

      const tag = btn.dataset.tag;
      btn.classList.toggle('active');

      if (btn.classList.contains('active')) {
        if (!filterState.selectedTags.includes(tag)) {
          filterState.selectedTags.push(tag);
        }
      } else {
        filterState.selectedTags = filterState.selectedTags.filter(t => t !== tag);
      }
      applyFilters(); // Apply filters immediately when tags are clicked
    });

    const priceSlider = document.getElementById('priceSlider');
    const currentPriceValue = document.getElementById('currentPriceValue');

    priceSlider?.addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      currentPriceValue.textContent = value === 0 ? 'Бесплатно' : value.toLocaleString('ru-RU');
      filterState.maxPrice = value;
      updateSliderBackground(e.target);
    });

    priceSlider?.addEventListener('change', () => {
      // Apply filter when the slider value is finalized (on release)
      applyFilters();
    });

    filterResetBtn?.addEventListener('click', () => {
      filterState.selectedTags = [];
      filterState.maxPrice = maxPriceFromDB;
      
      document.querySelectorAll('.filter-tag').forEach(btn => btn.classList.remove('active'));
      priceSlider.value = maxPriceFromDB;
      currentPriceValue.textContent = maxPriceFromDB.toLocaleString('ru-RU');
      updateSliderBackground(priceSlider);
      tagSearchInput.value = '';
      
      applyFilters();
    });

    filterApplyBtn?.addEventListener('click', () => {
      applyFilters();
      closeFilterPanel();
    });

    function handleSearch() {
      const desktopInput = document.getElementById('desktopSearchInput');
      const mobileInput = document.getElementById('mobileSearchInput');
      
      filterState.searchQuery = desktopInput?.value || mobileInput?.value || '';
      applyFilters();
    }

    document.getElementById('desktopSearchBtn')?.addEventListener('click', handleSearch);
    document.getElementById('desktopSearchBtnMobile')?.addEventListener('click', handleSearch);
    document.getElementById('mobileSearchBtn')?.addEventListener('click', handleSearch);
    document.getElementById('desktopSearchInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleSearch();
    });
    document.getElementById('mobileSearchInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleSearch();
    });

    document.addEventListener('click', (e) => {
      const tagBtn = e.target.closest('.card-tags .tag-btn');
      if (tagBtn) {
        const tag = tagBtn.dataset.tag;
        if (tag && !filterState.selectedTags.includes(tag)) {
          filterState.selectedTags.push(tag);
          document.querySelectorAll(`.filter-tag[data-tag="${tag}"]`).forEach(btn => {
            btn.classList.add('active');
          });
          applyFilters();
        }
      }
    });

    // Bottom sheet drag
    const bottomSheet = document.getElementById('bottomSheet');
    const sheetHandle = document.getElementById('sheetHandle');
    const states = ['peek', 'split', 'full'];
    let currentState = 1; // Start in 'split' state

    let startY = 0;
    let isDragging = false;
    let initialSheetTop = 0; // Store initial top position for dragging calculation

    sheetHandle.addEventListener('touchstart', (e) => {
      startY = e.touches[0].clientY;
      initialSheetTop = bottomSheet.getBoundingClientRect().top;
      isDragging = true;
      bottomSheet.style.transition = 'none'; // Disable transition during drag
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const deltaY = e.touches[0].clientY - startY;
      let newTop = initialSheetTop + deltaY;

      // Clamp newTop to prevent going above the header or below the bottom
      const headerHeight = document.querySelector('.header').offsetHeight;
      const maxSheetTop = window.innerHeight - bottomSheet.offsetHeight; // Max possible top is when sheet is fully collapsed
      const minSheetTop = headerHeight; // Minimum top is just below the header

      if (newTop < minSheetTop) newTop = minSheetTop;
      if (newTop > maxSheetTop) newTop = maxSheetTop;

      bottomSheet.style.top = `${newTop}px`;
      bottomSheet.style.transform = 'none'; // Remove transform during drag
    });

    document.addEventListener('touchend', () => {
      if (!isDragging) return;
      isDragging = false;
      bottomSheet.style.transition = 'transform 0.3s ease-out'; // Re-enable transition

      const sheetRect = bottomSheet.getBoundingClientRect();
      const sheetBottom = sheetRect.bottom;
      const peekThreshold = window.innerHeight - 84; // Approximate bottom for peek state
      const splitThreshold = window.innerHeight / 2 + document.querySelector('.header').offsetHeight; // Approximate middle for split
      const fullThreshold = document.querySelector('.header').offsetHeight; // Top for full state

      if (sheetBottom > splitThreshold) { // If mostly in the bottom half
        currentState = 0; // Peek
      } else if (sheetBottom > fullThreshold) { // If in the middle
        currentState = 1; // Split
      } else { // If in the top
        currentState = 2; // Full
      }
      
      bottomSheet.className = `bottom-sheet ${states[currentState]}`;
    });

    // Favorite toggle
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.favorite-btn');
      if (btn) {
        btn.classList.toggle('active');
        const id = btn.dataset.id;
        // In a real app, you would update this state on the server via API
        const clubIndex = allClubs.findIndex(c => c.id == id);
        if (clubIndex !== -1) {
            allClubs[clubIndex].isFavorite = !allClubs[clubIndex].isFavorite;
        }
      }
    });

    const leftPanel = document.getElementById('leftPanel');
    const desktopPanelHandle = document.getElementById('desktopPanelHandle');
    
    // Click to toggle
    desktopPanelHandle?.addEventListener('click', () => {
      desktopPanelCollapsed = !desktopPanelCollapsed;
      leftPanel.classList.toggle('collapsed', desktopPanelCollapsed);
      desktopPanelHandle.style.transition = 'transform 0.3s ease'; // Add transition to handle itself
    });

    // Drag to toggle on desktop
    let desktopDragStartX = 0;
    let isDesktopDragging = false;

    desktopPanelHandle?.addEventListener('mousedown', (e) => {
      desktopDragStartX = e.clientX;
      isDesktopDragging = true;
      e.preventDefault();
      leftPanel.style.transition = 'transform 0s'; // Disable transition during drag
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDesktopDragging) return;
      const deltaX = e.clientX - desktopDragStartX;
      const panelWidth = leftPanel.offsetWidth;
      const collapseThreshold = panelWidth * 0.3; // Collapse if dragged more than 30% to the left

      if (Math.abs(deltaX) > 50) { // Only act after a significant drag
        if (deltaX < -collapseThreshold && !desktopPanelCollapsed) {
          desktopPanelCollapsed = true;
          leftPanel.classList.add('collapsed');
        } else if (deltaX > collapseThreshold && desktopPanelCollapsed) {
          desktopPanelCollapsed = false;
          leftPanel.classList.remove('collapsed');
        }
        isDesktopDragging = false; // Reset after a decision
        leftPanel.style.transition = 'transform 0.3s ease'; // Re-enable transition
      }
    });

    document.addEventListener('mouseup', () => {
      if (isDesktopDragging) { // If mouseup happens without significant drag
        isDesktopDragging = false;
        leftPanel.style.transition = 'transform 0.3s ease'; // Re-enable transition
      }
    });

    // Initialize map (placeholder, actual map logic would be here)
    function initializeMap() {
      // This is a placeholder. In a real application, you would initialize
      // Yandex Maps here, potentially centering it on the user's location
      // or a default area, and then add markers based on fetched clubs.
      console.log("Map initialization placeholder.");
      // Example:
      // if (typeof ymaps !== 'undefined') {
      //   const mapInstance = new ymaps.Map("map", {
      //     center: [55.751574, 37.573856], // Moscow center as default
      //     zoom: 9
      //   });
      //   // Add markers from clubs data
      //   // clubs.forEach(club => {
      //   //   mapInstance.geoObjects.add(new ymaps.Placemark([lat, lon], { ... }));
      //   // });
      // }
    }

    // Call map initialization after DOM is ready and potentially after clubs are loaded
    // document.addEventListener('DOMContentLoaded', initializeMap); // Might need to be called after clubs load
    // Moved initialization to after clubs load or after DOMContentLoaded in this example
    document.addEventListener('DOMContentLoaded', () => {
      // Ensure map containers exist before trying to initialize
      if (document.getElementById('map') && typeof ymaps !== 'undefined') {
        initializeMap(); // Initial call for desktop map
      }
      if (document.getElementById('mobileMap') && typeof ymaps !== 'undefined') {
        // You might want a separate initialization for mobile map, or reuse the desktop one
        // For simplicity, calling it once here.
        console.log("Mobile map initialization placeholder.");
      }
    });

  </script>
</body>
</html>
