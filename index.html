<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мапка - Найди кружок для ребёнка</title>
  <link rel="canonical" href="https://xn--80aa3agq.xn--p1ai/">
  <meta name="description" content="Поиск детских кружков и секций на карте">
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Яндекс Карты API v3 -->
  <script src="https://api-maps.yandex.ru/v3/?apikey=58c38b72-57f7-4946-bc13-a256d341281a&lang=ru_RU"></script>
  <script src="map.js" defer></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --accent-color: #3b82f6; /* Более современный синий */
      --accent-hover: #2563eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
    }

    /* --- MODERN HEADER --- */
    .header {
      position: relative;
      z-index: 50;
      background: rgba(255, 255, 255, 0.9); /* Полупрозрачный белый */
      backdrop-filter: blur(12px); /* Эффект размытия фона */
      border-bottom: 1px solid var(--border-color);
      height: 64px;
      flex-shrink: 0;
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      height: 100%;
      gap: 24px;
      max-width: 1920px;
      margin: 0 auto;
    }

    .logoContainer {
      display: flex;
      align-items: center;
    }

    .mainLogo {
      height: 36px;
      display: block;
    }

    .nav-desktop {
      display: none;
      align-items: center;
      gap: 32px;
      margin-right: auto;
      margin-left: 48px;
    }

    .nav-desktop a {
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 15px;
      transition: color 0.2s;
    }

    .nav-desktop a:hover {
      color: var(--accent-color);
    }

    .header-right-desktop {
      display: none;
      align-items: center;
      gap: 20px;
    }

    .header-link {
      color: var(--text-primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .header-link:hover {
      background: #f3f4f6;
    }

    .header-right-mobile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn {
      background: transparent;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: #f3f4f6;
    }

    .icon-btn svg {
      width: 24px;
      height: 24px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Mobile Menu */
    .mobile-menu-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      z-index: 100;
    }

    .mobile-menu-overlay.active {
      display: block;
    }

    .mobile-menu {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      width: 300px;
      background: var(--bg-secondary);
      z-index: 101;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -4px 0 24px rgba(0,0,0,0.1);
    }

    .mobile-menu.active {
      transform: translateX(0);
    }

    .mobile-menu-header {
      display: flex;
      justify-content: flex-end;
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .mobile-menu-content {
      padding: 24px;
    }

    .mobile-menu nav {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .mobile-menu nav a {
      color: var(--text-primary);
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
    }

    /* Main Layout */
    .main-desktop {
      display: none;
      position: relative;
      height: calc(100vh - 64px);
      width: 100%;
      overflow: hidden;
    }

    .map-container {
      position: absolute;
      inset: 0;
      background: #e5e5e5;
      z-index: 1;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* --- ЛЕВАЯ ПАНЕЛЬ --- */
    .left-panel {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 560px; /* Увеличили ширину */
      max-width: 100%;
      display: flex;
      flex-direction: column;
      padding: 16px 0 16px 16px; /* Отступ только слева, справа нет (чтобы язычок прилипал) */
      z-index: 20;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .left-panel.collapsed {
      transform: translateX(-100%);
    }

    .left-panel > * {
      pointer-events: auto;
    }

    /* Оболочка для контента панели (Поиск + Список) */
    .panel-content-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-secondary);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      overflow: hidden;
      position: relative;
    }

    /* Поиск и фильтры внутри панели */
    .panel-header {
      padding: 16px 16px 8px 16px;
      background: var(--bg-secondary);
      z-index: 10;
      border-bottom: 1px solid transparent; /* Можно включить разделитель при скролле */
    }

    .search-filter {
      display: flex;
      gap: 12px;
      height: 48px;
    }

    .filter-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px;
      background: #f3f4f6; /* Светло-серый вместо синего */
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
    }

    .search-box {
      flex: 1;
      display: flex;
      background: #f3f4f6;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 4px;
      transition: all 0.2s;
    }

    .search-box:focus-within {
      background: #ffffff;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-box input {
      flex: 1;
      min-width: 0;
      background: transparent;
      color: var(--text-primary);
      border: none;
      padding: 0 12px;
      font-size: 15px;
      outline: none;
    }

    .search-box button {
      padding: 0 20px;
      background: var(--accent-color);
      border-radius: 9px;
      border: none;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .search-box button:hover {
      background: var(--accent-hover);
    }

    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      min-height: 0; /* Чтобы не ломало flex layout */
    }

    .active-filter-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #eff6ff;
      color: var(--accent-color);
      font-size: 13px;
      font-weight: 500;
      padding: 6px 10px;
      border-radius: 20px;
      border: 1px solid #bfdbfe;
    }

    .active-filter-chip button {
      background: none;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      opacity: 0.7;
    }
    
    .active-filter-chip button:hover {
        opacity: 1;
    }

    /* Список карточек */
    .cards-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px 16px 16px;
    }

    /* Scrollbar */
    .cards-scroll::-webkit-scrollbar { width: 6px; }
    .cards-scroll::-webkit-scrollbar-track { background: transparent; }
    .cards-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    .cards-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

    /* --- ЯЗЫЧОК / ПЕТЕЛЬКА --- */
    /* Теперь он позиционируется относительно .left-panel, но визуально прилипает к .panel-content-wrapper */
    .desktop-panel-handle {
      position: absolute;
      right: -24px; /* Выдвинут вправо */
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 48px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-left: none; /* Убираем левую границу, чтобы сливался */
      border-radius: 0 8px 8px 0;
      box-shadow: 4px 0 8px rgba(0,0,0,0.05); /* Тень только справа */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: -1; /* Под панель, чтобы граница не двоилась */
      pointer-events: auto;
      transition: background 0.2s;
    }
    
    /* Добавляем псевдоэлемент, чтобы перекрыть тень самой панели */
    .desktop-panel-handle::before {
        content: '';
        position: absolute;
        left: -2px;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--bg-secondary);
    }

    .desktop-panel-handle:hover {
      background: #f9fafb;
    }
    
    .desktop-panel-handle::before:hover {
        background: #f9fafb;
    }

    .desktop-panel-handle svg {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
      transition: transform 0.3s;
      position: relative;
      z-index: 2;
    }

    .left-panel.collapsed .desktop-panel-handle svg {
      transform: rotate(180deg);
    }

    /* Карточка кружка */
    .cards-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .club-card {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      transition: all 0.2s;
    }

    .club-card:hover {
      border-color: var(--accent-color);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .card-image {
      width: 160px; /* Фикс ширина фото */
      height: 120px; /* Фикс высота */
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      background: #e5e7eb;
      position: relative;
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .favorite-btn {
      position: absolute;
      top: 6px;
      right: 6px; /* Кнопка лайка справа сверху */
      left: auto;
      background: rgba(255,255,255,0.9);
      border-radius: 50%;
      padding: 6px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .favorite-btn:hover { transform: scale(1.1); }

    .favorite-btn svg {
      width: 18px;
      height: 18px;
      color: #9ca3af;
    }

    .favorite-btn.active svg {
      fill: #ef4444;
      color: #ef4444;
    }

    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .card-description {
      font-size: 14px; /* Увеличили шрифт */
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* Ограничение в 2 строки */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: auto; /* Теги прижимаются к верху, цена к низу */
    }

    .tag-btn {
      background: #f3f4f6;
      color: var(--text-secondary);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      font-weight: 500;
    }

    .card-bottom {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      margin-top: 12px;
    }

    .card-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .card-price.free {
      color: #10b981;
    }

    .card-btn {
      background: var(--accent-color);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      transition: background 0.2s;
    }

    .card-btn:hover {
      background: var(--accent-hover);
    }

    /* Mobile Layout */
    .main-mobile {
      display: block;
    }

    /* Filter Panel */
    .filter-panel {
      display: none;
      position: fixed;
      inset: 0;
      top: 64px;
      background: var(--bg-secondary);
      z-index: 40;
      flex-direction: column;
    }

    .filter-panel.active { display: flex; }

    .filter-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .filter-panel-content { padding: 16px; flex: 1; overflow-y: auto; }
    
    .filter-section { margin-bottom: 24px; }
    .filter-section h3 { font-size: 15px; font-weight: 600; margin-bottom: 12px; }

    .filter-tag {
        background: white;
        border: 1px solid var(--border-color);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
    }
    .filter-tag:hover { border-color: var(--accent-color); }
    .filter-tag.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

    .price-slider { width: 100%; accent-color: var(--accent-color); }

    .filter-panel-footer {
        padding: 16px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 12px;
        margin-top: auto;
    }
    
    .filter-reset-btn { flex: 1; padding: 12px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; }
    .filter-apply-btn { flex: 2; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; }

    /* MEDIA QUERIES - Адаптив */
    @media (min-width: 600px) { /* Снижен порог переключения (было 768px) */
      .header-inner { padding: 0 32px; }
      .nav-desktop { display: flex; }
      .header-right-desktop { display: flex; }
      .header-right-mobile { display: none; }
      
      .main-desktop { display: block; }
      .main-mobile { display: none; }

      /* Desktop Filter Modal - позиционируем рядом с кнопкой фильтров */
      .filter-panel {
        position: absolute;
        left: 24px; /* Внутри панели, поверх списка */
        top: 130px; /* Чуть ниже поиска */
        width: 340px;
        height: auto;
        max-height: 60vh;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        inset: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="logoContainer">
        <img src="logo.png" alt="Мапка" class="mainLogo">
      </div>

      <nav class="nav-desktop">
        <a href="#">Все категории</a>
        <a href="#">Новости</a>
        <a href="#">Помощь</a>
      </nav>

      <div class="header-right-desktop">
        <a href="#" class="header-link">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
          </svg>
          <span>Избранное</span>
        </a>
        <a href="#" class="header-link">
          <div class="avatar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
            </svg>
          </div>
          <span>Профиль</span>
        </a>
      </div>

      <div class="header-right-mobile">
        <button class="icon-btn" id="menuBtn" aria-label="Меню">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Menu -->
  <div class="mobile-menu-overlay" id="menuOverlay"></div>
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-header">
      <button class="icon-btn" id="closeMenuBtn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="mobile-menu-content">
      <nav>
        <a href="#">Главная</a>
        <a href="#">Избранное</a>
        <a href="#">Профиль</a>
        <a href="#">Помощь</a>
      </nav>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" id="filterPanel">
    <div class="filter-panel-header">
      <h2>Фильтры</h2>
      <button class="icon-btn" id="closeFilterBtn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="filter-panel-content">
      <div class="filter-section">
        <h3>Теги</h3>
        <input type="text" class="tag-search-input" id="tagSearchInput" placeholder="Поиск тега..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; margin-bottom:8px;">
        <div class="tag-suggestions" id="tagSuggestions"></div>
        <div class="filter-tags" id="filterTags" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        <button class="tags-expand-btn" id="tagsExpandBtn" style="margin-top:8px; background:none; border:none; color:#3b82f6; cursor:pointer;">Показать все</button>
      </div>
      <div class="filter-section">
        <h3>Цена до: <span id="currentPriceValue">5000</span> ₽</h3>
        <input type="range" class="price-slider" id="priceSlider" min="0" max="5000" value="5000" step="100">
      </div>
    </div>
    <div class="filter-panel-footer">
      <button class="filter-reset-btn" id="filterResetBtn">Сбросить</button>
      <button class="filter-apply-btn" id="filterApplyBtn">Применить</button>
    </div>
  </div>

  <!-- Desktop Layout -->
  <main class="main-desktop">
    <div class="map-container">
      <div id="map"></div>
    </div>

    <!-- Левая панель -->
    <div class="left-panel" id="leftPanel">
      <div class="panel-content-wrapper">
        <div class="panel-header">
          <div class="search-filter">
            <div class="search-box">
              <input type="search" placeholder="Поиск (футбол, танцы...)" id="desktopSearchInput">
              <button id="desktopSearchBtn">Найти</button>
            </div>
            <button class="filter-btn" id="desktopFilterBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
              </svg>
              <span>Фильтры</span>
            </button>
          </div>
          <div class="active-filters" id="desktopActiveFilters"></div>
        </div>

        <div class="cards-scroll">
          <div class="cards-list" id="desktopCards">
            <!-- Cards rendered here -->
          </div>
        </div>
      </div>

      <!-- Кнопка-язычок (снаружи wrapper'а) -->
      <div class="desktop-panel-handle" id="desktopPanelHandle">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      </div>
    </div>
  </main>

  <!-- Mobile Layout -->
  <main class="main-mobile">
    <div class="mobile-map">
      <div id="mobileMap"></div>
    </div>

    <div class="bottom-sheet split" id="bottomSheet">
      <div class="sheet-handle" id="sheetHandle">
        <div class="handle-bar"></div>
      </div>
      <div class="sheet-header">
        <div class="search-filter">
          <button class="filter-btn" id="mobileFilterBtn" style="padding:0 12px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
          </button>
          <div class="search-box">
            <input type="search" placeholder="Поиск..." id="mobileSearchInput">
            <button id="mobileSearchBtn" style="padding: 0 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="sheet-content">
        <div class="active-filters" id="mobileActiveFilters"></div>
        <div class="sheet-cards" id="mobileCards"></div>
      </div>
    </div>
  </main>

  <script>
    let filterState = {
      selectedTags: [],
      maxPrice: 5000,
      searchQuery: ''
    };

    let allTags = [];
    let allClubs = [];
    let maxPriceFromDB = 5000;
    let tagsExpanded = false;
    let desktopPanelCollapsed = false;

    const API_BASE = 'https://mapkarostov.ru/api';

    function formatPrice(priceCents) {
      if (priceCents === null || priceCents === undefined || priceCents === 0) {
        return { text: 'Бесплатно', isFree: true };
      }
      const priceRub = Math.round(priceCents / 100);
      return { text: `${priceRub.toLocaleString('ru-RU')} ₽`, isFree: false };
    }

    // --- ОБНОВЛЕННЫЙ ШАБЛОН КАРТОЧКИ ---
    function createCardHTML(club) {
      const price = formatPrice(club.price_cents);
      return `
        <div class="club-card" data-tags="${(club.tags || []).join(',').toLowerCase()}" data-price="${club.price_cents || 0}">
          <div class="card-image">
            <img src="${club.image}" alt="${club.name}">
            <button class="favorite-btn ${club.isFavorite ? 'active' : ''}" data-id="${club.id}">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
              </svg>
            </button>
          </div>
          
          <div class="card-content">
            <div class="card-title">${club.name}</div>
            <div class="card-description">${club.description}</div>
            
            <div class="card-tags">
              ${(club.tags || []).slice(0, 3).map(tag => `<span class="tag-btn">${tag}</span>`).join('')}
              ${(club.tags || []).length > 3 ? `<span class="tag-btn">+${club.tags.length - 3}</span>` : ''}
            </div>

            <div class="card-bottom">
              <span class="card-price ${price.isFree ? 'free' : ''}">${price.text}</span>
              <a href="/${encodeURIComponent(club.slug)}" class="card-btn">Подробнее</a>
            </div>
          </div>
        </div>
      `;
    }

    window.createCardHTML = createCardHTML;

    function initFilters(clubsData) {
      allClubs = clubsData;

      const tagSet = new Set();
      let maxPrice = 0;

      clubsData.forEach(club => {
        (club.tags || []).forEach(tag => tagSet.add(tag.toLowerCase()));
        const priceCents = club.price_cents || 0;
        const priceRub = Math.round(priceCents / 100);
        if (priceRub > maxPrice) maxPrice = priceRub;
      });

      allTags = Array.from(tagSet).sort();
      maxPriceFromDB = maxPrice > 0 ? maxPrice : 5000;

      const priceSlider = document.getElementById('priceSlider');
      const currentPriceValue = document.getElementById('currentPriceValue');

      if (priceSlider && currentPriceValue) {
        priceSlider.max = maxPriceFromDB;
        priceSlider.value = maxPriceFromDB;
        filterState.maxPrice = maxPriceFromDB;
        currentPriceValue.textContent = maxPriceFromDB.toLocaleString('ru-RU');
      }

      renderFilterTags();
    }

    async function fetchClubs(query = '', tags = [], maxPrice = null) {
      let url = `${API_BASE}/clubs/`;
      const params = [];
      if (query) params.push(`search=${encodeURIComponent(query)}`);
      if (tags.length > 0) params.push(`tags=${encodeURIComponent(tags.join(','))}`);
      if (maxPrice !== null && maxPrice > 0) params.push(`max_price_cents=${maxPrice * 100}`);

      if (params.length > 0) {
        url += `?${params.join('&')}`;
      }

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Нормализация: следим, чтобы были поля image, tags, price_cents
        return data.map(c => {
          let img = c.image || c.main_image_url || '';
          if (img && img.startsWith('/')) {
            const origin = location.hostname === 'localhost' || location.hostname === '127.0.0.1'
              ? 'http://localhost:8000'
              : `${location.protocol}//${location.host}`;
            img = origin + img;
          }

          return {
            id: c.id,
            name: c.name || '',
            slug: c.slug || c.id,
            description: c.description || '',
            image: img || 'https://via.placeholder.com/400x300?text=No+image',
            location: c.location || c.address_text || '',
            isFavorite: c.isFavorite || false,
            tags: c.tags || [],
            price_cents: c.price_cents || 0
          };
        });
      } catch (error) {
        console.error("Error fetching clubs:", error);
        return [];
      }
    }

    function renderCards(clubsData) {
      const desktop = document.getElementById('desktopCards');
      const mobile = document.getElementById('mobileCards');

      const html = clubsData.map(createCardHTML).join('');
      if (desktop) desktop.innerHTML = html;
      if (mobile) mobile.innerHTML = html;
    }

    window.initFilters = initFilters;

    // ПОЛНЫЙ список и applyFilters по allClubs
    let filteredClubs = [];

    function applyFilters() {
      const query = filterState.searchQuery.toLowerCase();
      const tags = filterState.selectedTags;
      const maxPriceCents = filterState.maxPrice * 100;

      const result = allClubs.filter(club => {
        if (query && !club.name.toLowerCase().includes(query)) {
          return false;
        }

        if (club.price_cents && club.price_cents > maxPriceCents) {
          return false;
        }

        if (tags.length > 0) {
          const clubTags = (club.tags || []).map(t => t.toLowerCase());
          if (!tags.every(t => clubTags.includes(t))) {
            return false;
          }
        }

        return true;
      });

      filteredClubs = result;
      renderCards(result);
      updateActiveFiltersDisplay();
    }

    function updateActiveFiltersDisplay() {
      ['desktopActiveFilters', 'mobileActiveFilters'].forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;

        let html = '';

        filterState.selectedTags.forEach(tag => {
          html += `
            <div class="active-filter-chip">
              ${tag}
              <button onclick="removeTagFilter('${tag}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          `;
        });

        if (filterState.maxPrice < maxPriceFromDB) {
          html += `
            <div class="active-filter-chip">
              До ${filterState.maxPrice.toLocaleString('ru-RU')} ₽
              <button onclick="removePriceFilter()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          `;
        }

        container.innerHTML = html;
      });
    }

    function removeTagFilter(tag) {
      filterState.selectedTags = filterState.selectedTags.filter(t => t !== tag);
      document.querySelectorAll(`.filter-tag[data-tag="${tag}"]`).forEach(btn => {
        btn.classList.remove('active');
      });
      applyFilters();
    }
    window.removeTagFilter = removeTagFilter;

    function removePriceFilter() {
      filterState.maxPrice = maxPriceFromDB;
      const priceSlider = document.getElementById('priceSlider');
      const currentPriceValue = document.getElementById('currentPriceValue');
      if (priceSlider && currentPriceValue) {
        priceSlider.value = maxPriceFromDB;
        currentPriceValue.textContent = maxPriceFromDB.toLocaleString('ru-RU');
      }
      applyFilters();
    }
    window.removePriceFilter = removePriceFilter;

    // Берём данные, которые сервер положил в window.initialClubs (если есть)
    const ssrClubs =
      (typeof window !== 'undefined' &&
      Array.isArray(window.initialClubs) &&
      window.initialClubs.length > 0)
        ? window.initialClubs
        : null;

    (async function initPage() {
      const containers = ['desktopCards', 'mobileCards']
        .map(id => document.getElementById(id))
        .filter(Boolean);

      containers.forEach(c => {
        if (!c) return;
        c.innerHTML = '<div style="padding:20px;text-align:center;">Загрузка кружков...</div>';
      });

      try {
        let clubs;

        if (ssrClubs) {
          console.log('Используем клубы из SSR:', ssrClubs);
          clubs = ssrClubs;
        } else {
          console.log('SSR нет, тянем клубы из API');
          clubs = await fetchClubs();      // fetchClubs у тебя уже определён выше
        }

        allClubs = clubs;
        filteredClubs = [...allClubs];

        // Инициализируем фильтры и рендерим карточки
        initFilters(allClubs);
        renderCards(filteredClubs);
      } catch (e) {
        console.error('initPage error:', e);
        containers.forEach(c => {
          if (!c) return;
          c.innerHTML = '<div style="padding:20px;text-align:center;">Ошибка загрузки</div>';
        });
      }
    })();

    // Mobile menu
    const menuBtn = document.getElementById('menuBtn');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    const menuOverlay = document.getElementById('menuOverlay');
    const mobileMenu = document.getElementById('mobileMenu');

    function openMenu() {
      menuOverlay.classList.add('active');
      mobileMenu.classList.add('active');
    }

    function closeMenu() {
      menuOverlay.classList.remove('active');
      mobileMenu.classList.remove('active');
    }

    menuBtn?.addEventListener('click', openMenu);
    closeMenuBtn?.addEventListener('click', closeMenu);
    menuOverlay?.addEventListener('click', closeMenu);

    const filterPanel = document.getElementById('filterPanel');
    const closeFilterBtn = document.getElementById('closeFilterBtn');
    const desktopFilterBtn = document.getElementById('desktopFilterBtn');
    const mobileFilterBtn = document.getElementById('mobileFilterBtn');
    const filterResetBtn = document.getElementById('filterResetBtn');
    const filterApplyBtn = document.getElementById('filterApplyBtn');

    function openFilterPanel() {
      filterPanel.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeFilterPanel() {
      filterPanel.classList.remove('active');
      document.body.style.overflow = '';
    }

    desktopFilterBtn?.addEventListener('click', openFilterPanel);
    mobileFilterBtn?.addEventListener('click', openFilterPanel);
    closeFilterBtn?.addEventListener('click', closeFilterPanel);

    const tagSearchInput = document.getElementById('tagSearchInput');
    const tagSuggestions = document.getElementById('tagSuggestions');

    tagSearchInput?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();

      if (!query) {
        tagSuggestions.classList.remove('active');
        return;
      }

      const matchingTags = allTags.filter(tag =>
        tag.includes(query) && !filterState.selectedTags.includes(tag)
      );

      if (matchingTags.length === 0) {
        tagSuggestions.classList.remove('active');
        return;
      }

      tagSuggestions.innerHTML = matchingTags.slice(0, 10).map(tag =>
        `<div class="tag-suggestion-item" data-tag="${tag}">${tag}</div>`
      ).join('');
      tagSuggestions.classList.add('active');
    });

    tagSearchInput?.addEventListener('blur', () => {
      setTimeout(() => {
        tagSuggestions.classList.remove('active');
      }, 200);
    });

    tagSuggestions?.addEventListener('click', (e) => {
      const item = e.target.closest('.tag-suggestion-item');
      if (!item) return;

      const tag = item.dataset.tag;
      if (tag && !filterState.selectedTags.includes(tag)) {
        filterState.selectedTags.push(tag);
        document.querySelectorAll(`.filter-tag[data-tag="${tag}"]`).forEach(btn => {
          btn.classList.add('active');
        });
      }

      tagSearchInput.value = '';
      tagSuggestions.classList.remove('active');
      applyFilters();
    });

    const tagsExpandBtn = document.getElementById('tagsExpandBtn');
    const filterTagsContainer = document.getElementById('filterTags');

    function renderFilterTags() {
      if (!filterTagsContainer) return;
      filterTagsContainer.innerHTML = allTags.map(tag =>
        `<button class="filter-tag" data-tag="${tag}">${tag}</button>`
      ).join('');
    }

    tagsExpandBtn?.addEventListener('click', () => {
      tagsExpanded = !tagsExpanded;
      // Здесь можно добавить логику сворачивания/разворачивания, если нужно
    });

    document.getElementById('filterTags')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.filter-tag');
      if (!btn) return;

      const tag = btn.dataset.tag;
      btn.classList.toggle('active');

      if (btn.classList.contains('active')) {
        if (!filterState.selectedTags.includes(tag)) {
          filterState.selectedTags.push(tag);
        }
      } else {
        filterState.selectedTags = filterState.selectedTags.filter(t => t !== tag);
      }
      applyFilters();
    });

    const priceSlider = document.getElementById('priceSlider');
    const currentPriceValue = document.getElementById('currentPriceValue');

    priceSlider?.addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      currentPriceValue.textContent = value === 0 ? 'Бесплатно' : value.toLocaleString('ru-RU');
      filterState.maxPrice = value;
    });

    priceSlider?.addEventListener('change', () => {
      applyFilters();
    });

    filterResetBtn?.addEventListener('click', () => {
      filterState.selectedTags = [];
      filterState.maxPrice = maxPriceFromDB;

      document.querySelectorAll('.filter-tag').forEach(btn => btn.classList.remove('active'));
      if (priceSlider && currentPriceValue) {
        priceSlider.value = maxPriceFromDB;
        currentPriceValue.textContent = maxPriceFromDB.toLocaleString('ru-RU');
      }
      if (tagSearchInput) tagSearchInput.value = '';

      applyFilters();
    });

    filterApplyBtn?.addEventListener('click', () => {
      applyFilters();
      closeFilterPanel();
    });

    function handleSearch() {
      const desktopInput = document.getElementById('desktopSearchInput');
      const mobileInput = document.getElementById('mobileSearchInput');

      filterState.searchQuery = (desktopInput?.value || mobileInput?.value || '').trim();
      applyFilters();
    }

    document.getElementById('desktopSearchBtn')?.addEventListener('click', handleSearch);
    document.getElementById('desktopSearchBtnMobile')?.addEventListener('click', handleSearch);
    document.getElementById('mobileSearchBtn')?.addEventListener('click', handleSearch);
    document.getElementById('desktopSearchInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleSearch();
    });
    document.getElementById('mobileSearchInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleSearch();
    });

    document.addEventListener('click', (e) => {
      const tagBtn = e.target.closest('.card-tags .tag-btn');
      if (tagBtn) {
        // Логика клика по тегу в карточке (опционально)
      }
    });

    // Bottom sheet drag
    const bottomSheet = document.getElementById('bottomSheet');
    const sheetHandle = document.getElementById('sheetHandle');
    
    if (bottomSheet && sheetHandle) {
      const STATE_ORDER = ['peek', 'split', 'full'];
      let currentStateIndex = 1; 
      let dragging = false;
      let startY = 0;
      let startTranslateY = 0;
      let lastTranslateY = 0;
    
      const stateOffsets = { peek: 0, split: 0, full: 0 };
    
      function recomputeStateOffsets() {
        const h = bottomSheet.getBoundingClientRect().height;
        stateOffsets.full = 0;
        stateOffsets.peek = Math.max(0, h - 84);
        stateOffsets.split = Math.round(h / 2);
      }
    
      function applyState(index) {
        currentStateIndex = Math.min(Math.max(index, 0), STATE_ORDER.length - 1);
        const key = STATE_ORDER[currentStateIndex];
        const y = stateOffsets[key];
        lastTranslateY = y;
        bottomSheet.style.transition = 'transform 0.25s ease-out';
        bottomSheet.style.transform = `translateY(${y}px)`;
        bottomSheet.classList.remove('peek', 'split', 'full');
        bottomSheet.classList.add(key);
      }
    
      recomputeStateOffsets();
      applyState(currentStateIndex);
    
      window.addEventListener('resize', () => {
        recomputeStateOffsets();
        applyState(currentStateIndex);
      });
    
      sheetHandle.addEventListener('touchstart', (e) => {
        if (e.touches.length !== 1) return;
        dragging = true;
        startY = e.touches[0].clientY;
        startTranslateY = lastTranslateY;
        bottomSheet.style.transition = 'none';
      }, { passive: true });
    
      document.addEventListener('touchmove', (e) => {
        if (!dragging) return;
        const touch = e.touches[0];
        const deltaY = touch.clientY - startY;
        const minY = stateOffsets.full;
        const maxY = stateOffsets.peek;
        let nextY = startTranslateY + deltaY;
        if (nextY < minY) nextY = minY;
        if (nextY > maxY) nextY = maxY;
        lastTranslateY = nextY;
        bottomSheet.style.transform = `translateY(${nextY}px)`;
        e.preventDefault();
      }, { passive: false });
    
      document.addEventListener('touchend', () => {
        if (!dragging) return;
        dragging = false;
        bottomSheet.style.transition = 'transform 0.25s ease-out';
        recomputeStateOffsets();
        let nearestIndex = 0;
        let nearestDist = Infinity;
        STATE_ORDER.forEach((key, idx) => {
          const d = Math.abs(lastTranslateY - stateOffsets[key]);
          if (d < nearestDist) {
            nearestDist = d;
            nearestIndex = idx;
          }
        });
        applyState(nearestIndex);
      });
    
      sheetHandle.addEventListener('click', () => {
        if (dragging) return;
        const nextIndex = (currentStateIndex + 1) % STATE_ORDER.length;
        applyState(nextIndex);
      });
    }

    // Favorite toggle
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.favorite-btn');
      if (btn) {
        btn.classList.toggle('active');
        const id = btn.dataset.id;
        const clubIndex = allClubs.findIndex(c => c.id == id);
        if (clubIndex !== -1) {
          allClubs[clubIndex].isFavorite = !allClubs[clubIndex].isFavorite;
        }
      }
    });

    // Desktop Panel Collapse Logic
    const leftPanel = document.getElementById('leftPanel');
    const desktopPanelHandle = document.getElementById('desktopPanelHandle');

    desktopPanelHandle?.addEventListener('click', () => {
      desktopPanelCollapsed = !desktopPanelCollapsed;
      if (desktopPanelCollapsed) {
        leftPanel.classList.add('collapsed');
      } else {
        leftPanel.classList.remove('collapsed');
      }
    });

    function initializeMap() {
      console.log("Map initialization placeholder.");
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (document.getElementById('map') && typeof ymaps !== 'undefined') {
        initializeMap();
      }
    });

    // Live search on input
    function handleLiveSearch(value) {
      filterState.searchQuery = value.trim();
      applyFilters();
    }

    document.getElementById('desktopSearchInput')?.addEventListener('input', (e) => {
      handleLiveSearch(e.target.value);
    });

    document.getElementById('mobileSearchInput')?.addEventListener('input', (e) => {
      handleLiveSearch(e.target.value);
    });
  </script>
</body>
</html>