<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Загрузка... - Мапка</title>
  <meta name="description" content="Подробная информация о кружке: расписание, цены, отзывы и расположение на карте.">
  <link rel="icon" href="/favicon.ico" />
  
  <meta property="og:title" content="Мапка">
  <meta property="og:description" content="Найди кружок для ребёнка">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/og-image.jpg">

  <!-- Яндекс Карты API v3 -->
  <script src="https://api-maps.yandex.ru/v3/?apikey=58c38b72-57f7-4946-bc13-a256d341281a&lang=ru_RU"></script>

  <style>
    /* --- CORE STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #f9fafb;
      --bg-secondary: white;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --accent-color: #69AFDF;
      --accent-hover: #5b9bc5;
      --header-height: 72px;
      --container-width: 1100px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 80px;
    }

    @media (min-width: 1024px) {
      body { padding-bottom: 0; }
    }

    /* --- HEADER --- */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      height: var(--header-height);
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      height: 100%;
      max-width: var(--container-width);
      margin: 0 auto;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 15px;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: #f3f4f6;
      color: var(--text-primary);
    }

    .header-title-scroll {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    .header-title-scroll.visible { opacity: 1; pointer-events: auto; }

    /* --- LAYOUT --- */
    .club-container {
      width: 100%;
      max-width: var(--container-width);
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
      align-items: start;
    }

    @media (min-width: 1024px) {
      .club-container {
        grid-template-columns: 2fr 1fr;
        padding-top: 40px;
      }
    }

    /* --- MAIN COLUMN --- */
    .club-main {
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-width: 0;
    }

    /* 1. Header Block */
    .header-block {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    .badge.category { background: var(--accent-color); color: white; }
    .badge.age { background: #e5e7eb; color: var(--text-secondary); }

    /* H1 ЗАГОЛОВОК - Крупный и заметный */
    h1.main-title {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      margin: 4px 0 0 0;
    }
    
    @media (min-width: 768px) { h1.main-title { font-size: 36px; } }

    .address-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 15px;
      margin-top: 4px;
    }
    .address-row svg { flex-shrink: 0; margin-top: 2px; }

    /* 2. Gallery (Свайп + Стрелки) */
    .gallery-container {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: #e5e7eb;
      aspect-ratio: 16/10;
      user-select: none;
      box-shadow: var(--shadow-card);
    }

    @media (min-width: 768px) { .gallery-container { aspect-ratio: 21/10; max-height: 450px; } }

    .gallery-track {
      display: flex;
      width: 100%;
      height: 100%;
      transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .gallery-slide {
      min-width: 100%;
      height: 100%;
    }
    
    .gallery-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.9);
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
      transition: all 0.2s;
      opacity: 0; /* Скрываем по умолчанию, показываем при ховере */
    }
    .gallery-container:hover .gallery-nav-btn { opacity: 1; }
    
    .gallery-nav-btn:hover { background: white; transform: translateY(-50%) scale(1.1); }
    .gallery-nav-btn.prev { left: 16px; }
    .gallery-nav-btn.next { right: 16px; }
    
    .gallery-dots {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
      background: rgba(0,0,0,0.3);
      padding: 6px 10px;
      border-radius: 20px;
      backdrop-filter: blur(4px);
    }
    .gallery-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      transition: all 0.2s;
      cursor: pointer;
    }
    .gallery-dot.active { background: white; transform: scale(1.2); }

    /* 3. Cards Styles */
    .section-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color);
    }

    .section-header { 
        font-size: 20px; 
        font-weight: 700; 
        margin-bottom: 16px; 
        color: var(--text-primary); 
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* 4. Price Block (Теперь над описанием) */
    .price-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-left: 4px solid var(--accent-color); /* Акцент */
    }
    
    .price-info h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 500; }
    .price-value { font-size: 28px; font-weight: 800; color: var(--text-primary); }
    .price-note { font-size: 14px; color: #10b981; font-weight: 500; background: #ecfdf5; padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 6px;}

    /* 5. Description & Socials */
    .section-text { font-size: 16px; line-height: 1.6; color: #374151; white-space: pre-line; }

    .social-block {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }
    .social-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; }
    .social-grid { display: flex; gap: 12px; flex-wrap: wrap; }
    
    .social-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s;
      flex: 1;
      justify-content: center;
      min-width: 140px;
      color: white;
    }
    .social-btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .social-vk { background: #0077FF; }
    .social-tg { background: #24A1DE; }
    .social-wa { background: #25D366; }

    /* 6. Schedule (Читаемый список) */
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }

    .schedule-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      background: white;
      border-bottom: 1px solid var(--border-color);
    }
    .schedule-row:last-child { border-bottom: none; }
    .schedule-row:nth-child(even) { background: #f9fafb; }

    .schedule-day { font-weight: 600; color: var(--text-primary); font-size: 15px; }
    .schedule-time { 
        font-family: 'Menlo', 'Monaco', monospace; 
        font-size: 14px; 
        color: var(--accent-color); 
        background: rgba(105, 175, 223, 0.1); 
        padding: 4px 10px; 
        border-radius: 6px; 
        font-weight: 600;
    }

    /* 7. Map */
    .map-wrapper {
      height: 320px;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #e5e7eb;
      position: relative;
    }
    
    .club-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
      transform: translate(-50%, -100%);
    }

    .club-marker-label {
      font-size: 12px;
      font-weight: 600;
      color: #111;
      background: white;
      padding: 4px 8px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      white-space: nowrap;
      margin-bottom: 4px;
    }

    .club-marker-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-color);
      box-shadow: 0 0 0 3px white, 0 4px 10px rgba(0,0,0,0.3);
    }

    /* Tags */
    .tags-section {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
    }
    .tag-chip {
        background: var(--bg-primary);
        color: var(--text-secondary);
        font-size: 13px;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
    }

    /* --- SIDEBAR (STICKY, DESKTOP ONLY) --- */
    .sidebar-wrapper {
      position: relative;
      height: 100%;
    }
    
    .sidebar-sticky {
      position: sticky;
      top: 100px;
      background: white;
      padding: 24px;
      border-radius: 20px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .cta-btn {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s;
    }
    
    .btn-primary { background: var(--accent-color); color: white; box-shadow: 0 4px 12px rgba(105, 175, 223, 0.3); }
    .btn-primary:hover { transform: translateY(-2px); background: var(--accent-hover); }
    
    .btn-outline { background: white; border: 2px solid var(--bg-primary); color: var(--text-primary); }
    .btn-outline:hover { border-color: var(--accent-color); color: var(--accent-color); }

    /* --- MOBILE BOTTOM BAR --- */
    .mobile-bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    @media (min-width: 1024px) { .mobile-bottom-bar { display: none; } }

  </style>
</head>
<body>

  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
        <span>Назад</span>
      </a>
      <!-- Title appears here on scroll -->
      <div class="header-title-scroll" id="headerScrollTitle">Загрузка...</div>
      
      <button class="back-btn" style="border:none; background:none;" aria-label="Поделиться" onclick="alert('Ссылка скопирована!')">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
        </svg>
      </button>
    </div>
  </header>

  <div class="club-container" id="mainContainer">
     <div style="padding:40px; text-align:center; color:#999;">Загрузка данных...</div>
  </div>

  <!-- Mobile Actions -->
  <div class="mobile-bottom-bar" id="mobileBottomBar">
      <!-- Populated by JS -->
  </div>

  <script>
    // === API CONFIG ===
    const API_BASE = (function(){
        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
            return "http://localhost:8000/api";
        }
        return "https://mapkarostov.ru/api"; 
    })();

    // --- UTILS ---
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    
    // Получаем slug
    const url = new URL(window.location.href);
    let slug = url.searchParams.get('slug');
    if (!slug) {
      const path = url.pathname.replace(/^\/+|\/+$/g, "");
      if (path && path !== "club.html" && path !== "index.html") slug = path;
    }

    let club = null;
    let currentPhotoIdx = 0;
    let showFullPhone = false;

    // --- DEMO DATA (Fallback) ---
    const DEMO_CLUB = {
        title: "Футбольная Академия 'Чемпион'",
        category: "Спорт",
        minAge: 5,
        maxAge: 16,
        price: 5500,
        priceNotes: "за 12 тренировок",
        address: "г. Ростов-на-Дону, ул. Ленина, д. 42",
        phone: "+79991234567",
        description: "Приглашаем детей от 5 до 16 лет в нашу футбольную школу!",
        tags: ["Футбол", "Спорт", "Команда"],
        photos: [
            "https://images.unsplash.com/photo-1517466787929-bc90951d0974?q=80&w=1200&auto=format&fit=crop"
        ],
        schedules: [
            { day: "Понедельник", time: "17:00 - 18:30" }
        ],
        socialLinks: { vk: "https://vk.com", telegram: "https://t.me" },
        capacity: 15
    };

    // --- FETCH ---
    async function fetchClubData(slug) {
        // Если slug не задан, возвращаем демо
        if (!slug) return DEMO_CLUB;

        try {
            const res = await fetch(`${API_BASE}/clubs`);
            if (!res.ok) throw new Error("API Error");
            const list = await res.json();
            
            // Ищем нужный
            const found = list.find(c => String(c.slug) === String(slug) || String(c.id) === String(slug));
            
            return found || DEMO_CLUB;
        } catch (e) {
            console.warn("Backend unavailable or network error. Using DEMO data.", e);
            return DEMO_CLUB;
        }
    }

    // --- NORMALIZE (Bulletproof) ---
    function normalizeClub(apiData) {
        if (!apiData) return normalizeClub(DEMO_CLUB);

        // 1. Нормализация фото (image строка -> photos массив)
        const rawPhotos = apiData.image || apiData.photos;
        let photos = [];
        
        if (Array.isArray(rawPhotos)) {
            photos = rawPhotos;
        } else if (rawPhotos && typeof rawPhotos === 'string') {
            photos = [rawPhotos]; // Если пришла одна строка, делаем массив
        } else {
            photos = DEMO_CLUB.photos; // Если ничего нет, берем демо
        }
        
        // Fix URLs
        photos = photos.map(p => {
            if (!p) return ""; 
            if (p.startsWith('http')) return p;
            if (p.startsWith('/')) return "https://mapkarostov.ru" + p;
            return p;
        }).filter(Boolean); // Убираем пустые

        return {
            title: apiData.name || apiData.title || "Без названия",
            category: (apiData.tags && apiData.tags[0]) || "Кружок",
            minAge: apiData.min_age || apiData.minAge || 0,
            maxAge: apiData.max_age || apiData.maxAge || 18,
            price: apiData.price_cents ? Math.round(apiData.price_cents / 100) : (apiData.price || 0),
            priceNotes: apiData.price_note || apiData.priceNotes || "",
            address: apiData.location || apiData.address_text || apiData.address || "Адрес не указан",
            phone: apiData.phone || "",
            description: apiData.description || "",
            schedules: Array.isArray(apiData.schedules) ? apiData.schedules : [],
            socialLinks: apiData.social_links || apiData.socialLinks || {},
            tags: Array.isArray(apiData.tags) ? apiData.tags : [],
            webSite: apiData.site || apiData.webSite || ""
        };
    }

    // --- RENDER ---
    async function initPage() {
        try {
            const rawData = await fetchClubData(slug);
            club = normalizeClub(rawData);

            document.title = `${club.title} - Мапка`;
            const container = document.getElementById('mainContainer');
            const mobileBar = document.getElementById('mobileBottomBar');
            const headerTitle = document.getElementById('headerScrollTitle');

            if (headerTitle) headerTitle.textContent = club.title;

            const priceStr = club.price > 0 ? `${club.price.toLocaleString('ru-RU')} ₽` : "Бесплатно";
            const ageStr = `${club.minAge} - ${club.maxAge} лет`;

            // HTML GENERATION (with safe navigation ?.)
            let html = `
                <div class="club-main">
                    <!-- HEADER BLOCK -->
                    <div class="header-block">
                        <div class="badges">
                            <span class="badge category">${escapeHtml(club.category)}</span>
                            <span class="badge age">${ageStr}</span>
                        </div>
                        <h1 class="main-title">${escapeHtml(club.title)}</h1>
                        <div class="address-row">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            <span>${escapeHtml(club.address)}</span>
                        </div>
                    </div>

                    <!-- GALLERY -->
                    <div class="gallery-container" id="galleryContainer">
                        <div class="gallery-track" id="galleryTrack">
                            ${club.photos?.length > 0 ? club.photos.map(src => `<div class="gallery-slide"><img src="${src}" alt="Фото"></div>`).join('') : '<div class="gallery-slide"><img src="https://via.placeholder.com/800x400?text=No+Photo" alt="No Photo"></div>'}
                        </div>
                        ${club.photos?.length > 1 ? `
                            <button class="gallery-nav-btn prev" id="btnPrev"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <button class="gallery-nav-btn next" id="btnNext"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                            <div class="gallery-dots">
                                ${club.photos.map((_, i) => `<div class="gallery-dot ${i===0?'active':''}" data-idx="${i}"></div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- PRICE -->
                    <div class="section-card price-card">
                        <div class="price-info">
                            <h3>Стоимость обучения</h3>
                            <div class="price-value">${priceStr}</div>
                            ${club.priceNotes ? `<div class="price-note">${escapeHtml(club.priceNotes)}</div>` : ''}
                        </div>
                    </div>

                    <!-- ABOUT -->
                    <div class="section-card">
                        <h2 class="section-header">О кружке</h2>
                        <div class="section-text">${escapeHtml(club.description)}</div>
                        
                        <!-- Tags -->
                        ${club.tags?.length > 0 ? `
                            <div class="tags-section">
                                ${club.tags.map(t => `<span class="tag-chip">${escapeHtml(t)}</span>`).join('')}
                            </div>
                        ` : ''}

                        <!-- Socials -->
                        ${(club.socialLinks && (club.socialLinks.vk || club.socialLinks.telegram)) ? `
                            <div class="social-block">
                                <div class="social-title">Следите за нами в соцсетях:</div>
                                <div class="social-grid">
                                    ${club.socialLinks.vk ? `<a href="${club.socialLinks.vk}" target="_blank" class="social-btn social-vk"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.07 2H8.93C5.1 2 2 5.1 2 8.93v6.14C2 18.9 5.1 22 8.93 22h6.14c3.83 0 6.93-3.1 6.93-6.93V8.93C22 5.1 18.9 2 15.07 2zM18 13.5h-1.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5H18c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5z"/></svg> ВКонтакте</a>` : ''}
                                    ${club.socialLinks.telegram ? `<a href="${club.socialLinks.telegram}" target="_blank" class="social-btn social-tg"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.665 3.717l-17.73 6.837c-1.21.486-1.203 1.161-.222 1.462l4.552 1.42l10.532-6.645c.498-.303.953-.14.579.192l-8.533 7.701l-.25 3.635c.34 0 .63-.166.875-.411l2.368-2.288l4.922 3.635c.907.5 1.56.242 1.783-.855l3.226-15.228c.328-1.536-.576-2.193-1.602-1.745z"/></svg> Telegram</a>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- SCHEDULE -->
                    <div class="section-card">
                        <h2 class="section-header">Расписание занятий</h2>
                        <div class="schedule-list">
                            ${club.schedules?.length > 0 ? club.schedules.map(s => `
                                <div class="schedule-row">
                                    <div class="schedule-day">${escapeHtml(s.day)}</div>
                                    <div class="schedule-time">${escapeHtml(s.time)}</div>
                                </div>
                            `).join('') : '<div class="section-text" style="color:#999; padding:12px;">Уточняйте у администратора</div>'}
                        </div>
                    </div>

                    <!-- MAP -->
                    <div class="section-card" style="padding:0; overflow:hidden;">
                        <div class="map-wrapper" id="clubMap"></div>
                        <div style="padding:16px;">
                            <div style="font-weight:600; margin-bottom:4px; font-size:14px;">Адрес:</div>
                            <div style="color:#555; font-size:15px;">${escapeHtml(club.address)}</div>
                        </div>
                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="sidebar-wrapper">
                    <div class="sidebar-sticky">
                        <div style="text-align:center; margin-bottom:12px;">
                            <div style="font-size:14px; color:#777;">Запись в группу</div>
                            <div style="font-weight:800; font-size:24px; color:var(--text-primary); margin-top:4px;">${club.phone ? maskPhone(club.phone) : ''}</div>
                        </div>
                        <button class="cta-btn btn-primary" onclick="togglePhone(this, '${club.phone}')">Показать номер</button>
                        <button class="cta-btn btn-outline" onclick="alert('Функция в разработке')">Написать сообщение</button>
                        <div style="font-size:11px; color:#999; text-align:center; line-height:1.4; margin-top:8px;">Нажимая кнопку, вы соглашаетесь с политикой конфиденциальности</div>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Mobile Actions
            mobileBar.innerHTML = `
                <button class="cta-btn btn-primary" style="flex:1" onclick="togglePhone(this, '${club.phone}')">Позвонить</button>
                <button class="cta-btn btn-outline" style="width:auto; padding:12px;" onclick="alert('Функция в разработке')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                </button>
            `;

            // Init Map & Gallery
            initMap(club.address);
            initGallery();
            
            // Scroll listener
            window.addEventListener('scroll', () => {
                const offset = window.scrollY;
                if (offset > 200) headerTitle.classList.add('visible');
                else headerTitle.classList.remove('visible');
            });

        } catch (err) {
            console.error("Render error:", err);
            document.getElementById('mainContainer').innerHTML = `<div style="text-align:center; padding:40px; color:red">Ошибка отображения: ${err.message}</div>`;
        }
    }

    // --- GALLERY LOGIC ---
    function initGallery() {
        const track = document.getElementById('galleryTrack');
        const slides = document.querySelectorAll('.gallery-slide');
        const dots = document.querySelectorAll('.gallery-dot');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');

        if (!slides || slides.length <= 1) return;

        function updateSlide(idx) {
            currentPhotoIdx = idx;
            const offset = -idx * 100;
            track.style.transform = `translateX(${offset}%)`;
            dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        }

        if(btnPrev) btnPrev.addEventListener('click', () => updateSlide((currentPhotoIdx - 1 + slides.length) % slides.length));
        if(btnNext) btnNext.addEventListener('click', () => updateSlide((currentPhotoIdx + 1) % slides.length));
        dots.forEach(d => d.addEventListener('click', () => updateSlide(Number(d.dataset.idx))));

        // Swipe support
        let startX = 0;
        let isDragging = false;

        track.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; isDragging = true; }, {passive: true});
        track.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) updateSlide((currentPhotoIdx + 1) % slides.length);
                else updateSlide((currentPhotoIdx - 1 + slides.length) % slides.length);
            }
            isDragging = false;
        });
    }

    // --- MAP LOGIC ---
    async function initMap(address) {
        if (!address || !window.ymaps3) return;
        try {
            await ymaps3.ready;
            const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapMarker } = ymaps3;
            const geocodeUrl = `https://geocode-maps.yandex.ru/1.x/?format=json&apikey=58c38b72-57f7-4946-bc13-a256d341281a&geocode=${encodeURIComponent(address)}`;
            const res = await fetch(geocodeUrl);
            const data = await res.json();
            const pos = data.response.GeoObjectCollection.featureMember[0]?.GeoObject?.Point?.pos;
            if (!pos) return;
            const [lng, lat] = pos.split(' ').map(Number);

            const mapContainer = document.getElementById('clubMap');
            mapContainer.innerHTML = '';
            
            const map = new YMap(mapContainer, { location: { center: [lng, lat], zoom: 16 } });
            map.addChild(new YMapDefaultSchemeLayer());
            map.addChild(new YMapDefaultFeaturesLayer());

            const el = document.createElement('div');
            el.className = 'club-marker';
            el.innerHTML = `<div class="club-marker-label">${club.title}</div><div class="club-marker-dot"></div>`;
            map.addChild(new YMapMarker({ coordinates: [lng, lat] }, el));
        } catch (e) { console.warn("Map error", e); }
    }

    // --- UTILS ---
    window.togglePhone = function(btn, phone) {
        if (!phone) return;
        showFullPhone = !showFullPhone;
        if (showFullPhone) {
             btn.innerHTML = `<span style="font-size:18px;">${phone}</span>`;
             window.location.href = `tel:${phone}`;
        } else {
             btn.innerHTML = `Показать номер`; 
        }
    };

    function maskPhone(phone) {
        if (!phone) return "";
        if (phone.length < 10) return phone;
        return phone.substr(0, 8) + "••-••";
    }

    initPage();
  </script>
</body>
</html>