<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapka - Страница кружка</title>
  <link rel="canonical" href="https://xn--80aa3agq.xn--p1ai/">
  <!-- Подключаем Яндекс.Карты API -->
  <script src="https://api-maps.yandex.ru/v3/?apikey=58c38b72-57f7-4946-bc13-a256d341281a&lang=ru_RU"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #1a1a1a;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #565555;
      color: white;
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      height: 56px;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .back-btn:hover {
      opacity: 0.8;
    }

    .back-btn svg {
      width: 24px;
      height: 24px;
    }

    .header-title {
      flex: 1;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .icon-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
    }

    .icon-btn svg {
      width: 24px;
      height: 24px;
    }
    

    .icon-btn.active svg {
      fill: #ef4444;
      color: #ef4444;
    }

    /* Gallery */
    .gallery {
      background: #d1d1d1;
    }

    .gallery-main {
      position: relative;
      aspect-ratio: 16/10;
      max-height: 400px;
      cursor: pointer;
    }

    .gallery-main img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.8);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .gallery-nav:hover {
      background: white;
    }

    .gallery-nav.prev {
      left: 8px;
    }

    .gallery-nav.next {
      right: 8px;
    }

    .gallery-counter {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 14px;
    }

    .gallery-thumbs {
      display: flex;
      gap: 8px;
      padding: 12px;
      overflow-x: auto;
    }

    .gallery-thumb {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      opacity: 0.7;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .gallery-thumb.active {
      opacity: 1;
      border-color: #69AFDF;
    }

    .gallery-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Content */
    .content {
      padding: 24px 16px;
      max-width: 1024px;
      margin: 0 auto;
    }

    /* Title section */
    .title-section {
      margin-bottom: 24px;
    }

    .badges {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .category-badge {
      background: #69AFDF;
      color: white;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 14px;
    }

    .age-text {
      color: #666;
      font-size: 14px;
    }

    .club-title {
      font-size: 24px;
      font-weight: 500;
    }

    /* Info cards grid */
    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .info-card {
      background: #d1d1d1;
      border-radius: 16px;
      padding: 16px;
    }

    .info-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .info-label svg {
      width: 16px;
      height: 16px;
    }

    .info-value {
      font-size: 18px;
      font-weight: 500;
    }

    .info-note {
      font-size: 14px;
      color: #69AFDF;
      margin-top: 4px;
    }

    /* Section */
    .section {
      background: #d1d1d1;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title svg {
      width: 20px;
      height: 20px;
    }

    /* Schedule */
    .schedule-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .schedule-item {
      background: white;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .schedule-item svg {
      width: 20px;
      height: 20px;
      color: #69AFDF;
    }

    .schedule-day {
      font-weight: 500;
    }

    .schedule-time {
      font-size: 14px;
      color: #666;
    }

    /* Description box */
    .description-box {
      background: white;
      border-radius: 12px;
      padding: 16px;
      line-height: 1.6;
      white-space: pre-line;
    }

    /* Tags */
    .tags-section {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .tag-btn {
      background: #d1d1d1;
      color: #1a1a1a;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s;
    }

    .tag-btn:hover {
      background: #c1c1c1;
    }

    .tag-btn svg {
      width: 12px;
      height: 12px;
    }

    /* Contacts */
    .contact-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .contact-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .contact-left svg {
      width: 20px;
      height: 20px;
      color: #69AFDF;
    }

    .show-phone-btn {
      background: none;
      border: none;
      color: #69AFDF;
      font-size: 14px;
      cursor: pointer;
    }

    .social-links {
      display: flex;
      gap: 12px;
    }

    .social-link {
      background: white;
      border-radius: 12px;
      padding: 16px;
      flex: 1;
      text-align: center;
      color: #69AFDF;
      text-decoration: none;
      transition: background 0.2s;
    }

    .social-link:hover {
      background: #f0f0f0;
    }

    /* Map container - убрали placeholder стили, добавили реальные стили для карты */
    .map-container {
      background: white;
      border-radius: 12px;
      height: 256px;
      overflow: hidden;
    }

    /* Стили для меток на карте клуба */
    .club-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Центрируем метку относительно координат (снизу по центру) */
      transform: translate(-50%, -100%);
    }

    .club-marker-label {
      font-size: 13px;
      font-weight: 500;
      color: #111;
      background: rgba(255,255,255,0.95);
      padding: 6px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      white-space: nowrap;
      margin-bottom: 6px;
    }

    .club-marker-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #69AFDF;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      border: 3px solid white;
    }

    /* Fixed bottom actions */
    .bottom-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e5e5;
      padding: 16px;
      display: flex;
      gap: 12px;
      z-index: 40;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s;
    }

    .action-btn:hover {
      transform: scale(1.02);
    }

    .action-btn.primary {
      background: #69AFDF;
      color: white;
    }

    .action-btn.secondary {
      background: #565555;
      color: white;
    }

    .action-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Fullscreen gallery */
    .fullscreen-gallery {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 100;
      background: black;
      align-items: center;
      justify-content: center;
    }

    .fullscreen-gallery.active {
      display: flex;
    }

    .fullscreen-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 10;
    }

    .fullscreen-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .fullscreen-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .fullscreen-nav.prev {
      left: 16px;
    }

    .fullscreen-nav.next {
      right: 16px;
    }

    .fullscreen-counter {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 8px 16px;
      border-radius: 999px;
    }

    /* Desktop styles */
    @media (min-width: 768px) {
      .header-inner {
        padding: 0 40px;
        height: 64px;
      }

      .gallery {
        display: flex;
        justify-content: center;
      }

      .header-title {
        font-size: 16px;
      }

      .gallery-main {
        aspect-ratio: 21/9;
        max-height: 500px;
      }

      .gallery-nav {
        width: 48px;
        height: 48px;
      }

      .gallery-nav.prev {
        left: 16px;
      }

      .gallery-nav.next {
        right: 16px;
      }

      .gallery-thumb {
        width: 80px;
        height: 80px;
      }

      .content {
        padding: 32px 40px;
      }

      .club-title {
        font-size: 36px;
      }

      .info-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .section {
        padding: 24px;
      }

      .section-title {
        font-size: 20px;
      }

      .schedule-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .map-container {
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
        <span class="back-text" style="display: none;">Назад</span>
      </a>
      <h1 class="header-title" id="headerTitle">Загрузка...</h1>
      <button class="icon-btn" id="favoriteBtn" aria-label="Избранное">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
        </svg>
      </button>
    </div>
  </header>

  <main id="mainContent">
    <!-- Content will be loaded by JavaScript -->
  </main>

  <!-- Fixed Bottom Actions -->
  <div class="bottom-actions">
    <button class="action-btn primary">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
      </svg>
      Позвонить
    </button>
    <button class="action-btn secondary">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
      </svg>
      Написать
    </button>
  </div>

  <!-- Fullscreen Gallery -->
  <div class="fullscreen-gallery" id="fullscreenGallery">
    <button class="fullscreen-close" id="closeGallery">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="24" height="24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
      </svg>
    </button>
    <img class="fullscreen-image" id="fullscreenImage" src="/placeholder.svg" alt="">
    <button class="fullscreen-nav prev" id="fullscreenPrev">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="24" height="24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
      </svg>
    </button>
    <button class="fullscreen-nav next" id="fullscreenNext">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" width="24" height="24">
        <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
      </svg>
    </button>
    <div class="fullscreen-counter" id="fullscreenCounter">1 / 3</div>
  </div>

  <script>
    // === Конфигурация API ===
    const API_BASE = (function(){
      try {
        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
          return "http://localhost:8000/api";
        }
        return `${location.protocol}//${location.host}/api`;
      } catch(e) {
        return "http://localhost:8000/api";
      }
    })();

    // получаем slug из URL
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('slug') || 'karate-tigr';

    // модель клуба, будет заполнена из API
    let club = null;
    let currentPhoto = 0;
    let showFullPhone = false;

    // --- Хелперы для работы с API ---
    async function fetchClubBySlug(slug) {
      try {
        const res = await fetch(`${API_BASE}/clubs`);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const arr = await res.json();
        return arr.find(c => String(c.slug) === String(slug) || String(c.id) === String(slug)) || null;
      } catch (e) {
        console.error('fetchClubBySlug failed', e);
        return null;
      }
    }

    function makeClubModel(apiClub) {
      if (!apiClub) return null;
      const photos = apiClub.image
        ? [ (apiClub.image.startsWith('/') ? (location.origin + apiClub.image) : apiClub.image) ]
        : ['https://via.placeholder.com/1200x700?text=No+image'];

      const price = apiClub.price_cents ? Math.round(apiClub.price_cents / 100) : null;

      return {
        title: apiClub.name || '',
        category: (apiClub.tags && apiClub.tags[0]) || 'Кружок',
        minAge: apiClub.minAge || '',
        maxAge: apiClub.maxAge || '',
        priceMin: price || 0,
        priceMax: price || (price || 0),
        priceType: 'monthly',
        priceNotes: apiClub.price_note || '',
        address: apiClub.location || '',
        phone: apiClub.phone || '',
        capacity: apiClub.capacity || null,
        photos: photos,
        schedules: apiClub.schedules || [],
        description: apiClub.description || '',
        teacherInfo: apiClub.teacherInfo || '',
        tags: apiClub.tags || [],
        webSite: apiClub.webSite || '',
        socialLinks: apiClub.socialLinks || {}
      };
    }

    // --- Функция рендера страницы из модели club ---
    function renderClub() {
      if (!club) return;
      document.getElementById('headerTitle').textContent = club.title || 'Кружок';
      document.title = `${club.title || 'Кружок'} - Mapka`;

      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <section class="gallery">
          <div class="gallery-main" id="galleryMain">
            <img src="${club.photos[0]}" alt="${escapeHtml(club.title)}" id="mainImage" />
            <div class="gallery-counter" id="galleryCounter">1 / ${club.photos.length}</div>
          </div>
          ${club.photos.length > 1 ? `<div class="gallery-thumbs" id="galleryThumbs">
              ${club.photos.map((p,i) => `<div class="gallery-thumb ${i===0?'active':''}" data-index="${i}"><img src="${p}" alt=""></div>`).join('')}
            </div>` : ''}
        </section>

        <div class="content">
          <div class="title-section">
            <div class="badges">
              <span class="category-badge">${escapeHtml(club.category)}</span>
              ${club.minAge || club.maxAge ? `<span class="age-text">${escapeHtml(String(club.minAge))}${club.minAge && club.maxAge ? ' - ' : ''}${escapeHtml(String(club.maxAge))} лет</span>` : ''}
            </div>
            <h1 class="club-title">${escapeHtml(club.title)}</h1>
          </div>

          <div class="info-grid">
            <div class="info-card">
              <p class="info-label">Стоимость</p>
              <p class="info-value">${Number(club.priceMin).toLocaleString('ru-RU')} ₽ ${club.priceType === 'monthly' ? '/ мес' : ''}</p>
              ${club.priceNotes ? `<p class="info-note">${escapeHtml(club.priceNotes)}</p>` : ''}
            </div>
            <div class="info-card">
              <p class="info-label">Адрес</p>
              <p class="info-value" style="font-size:16px;">${escapeHtml(club.address)}</p>
            </div>
            ${club.capacity ? `<div class="info-card"><p class="info-label">В группе</p><p class="info-value">до ${escapeHtml(String(club.capacity))} человек</p></div>` : ''}
          </div>

          <div class="section">
            <h2 class="section-title">Расписание</h2>
            <div class="schedule-grid">
              ${ (club.schedules && club.schedules.length) ? club.schedules.map(s => `
                <div class="schedule-item"><svg ...></svg><div><p class="schedule-day">${escapeHtml(s.day)}</p><p class="schedule-time">${escapeHtml(s.time)}</p></div></div>
              `).join('') : `<div class="muted" style="padding:8px">Расписание не указано</div>`}
            </div>
          </div>

          <div class="section">
            <h2 class="section-title">О кружке</h2>
            <div class="description-box">${escapeHtml(club.description)}</div>
          </div>

          ${club.teacherInfo ? `<div class="section"><h2 class="section-title">Преподаватель</h2><div class="description-box">${escapeHtml(club.teacherInfo)}</div></div>` : ''}

          <div class="tags-section">
            ${ (club.tags||[]).map(t => `<button class="tag-btn">${escapeHtml(t)}</button>`).join('') }
          </div>

          <div class="section">
            <h2 class="section-title">Контакты</h2>
            <div class="contact-item">
              <div class="contact-left">
                <svg ...></svg>
                <span id="phoneDisplay">${escapeHtml(maskPhone(club.phone || ''))}</span>
              </div>
              <button class="show-phone-btn" id="showPhoneBtn">Показать</button>
            </div>
            ${club.webSite ? `<a href="${escapeAttr(club.webSite)}" target="_blank" class="contact-item" style="text-decoration:none"><div class="contact-left"><svg ...></svg><span style="color:#69AFDF;">${escapeHtml(club.webSite)}</span></div></a>` : ''}
          </div>

          <div class="section">
            <h2 class="section-title">На карте</h2>
            <div class="map-container" id="clubMap"></div>
          </div>
        </div>
      `;

      // gallery behavior (simple)
      const thumbs = document.querySelectorAll('.gallery-thumb');
      thumbs.forEach(t => t.addEventListener('click', () => {
        const i = Number(t.dataset.index || 0);
        currentPhoto = i;
        updateGallery();
      }));

      // counter / prev-next via clicking on main image
      const mainImage = document.getElementById('mainImage');
      if (mainImage) {
        mainImage.addEventListener('click', () => {
          if (club.photos.length > 1) {
            currentPhoto = (currentPhoto + 1) % club.photos.length;
            updateGallery();
          }
        });
      }

      // phone toggle
      const showBtn = document.getElementById('showPhoneBtn');
      if (showBtn) {
        showBtn.addEventListener('click', () => {
          showFullPhone = !showFullPhone;
          document.getElementById('phoneDisplay').textContent = showFullPhone ? (club.phone || '') : maskPhone(club.phone || '');
          showBtn.textContent = showFullPhone ? 'Скрыть' : 'Показать';
        });
      }

      // init map (best-effort)
      try {
        initClubMap(club.address, club.title);
      } catch (e) {
        console.warn('initClubMap failed', e);
      }

      updateGallery();
    }

    function updateGallery() {
      const img = document.getElementById('mainImage');
      const counter = document.getElementById('galleryCounter');
      if (!img) return;
      img.src = club.photos[currentPhoto];
      if (counter) counter.textContent = `${currentPhoto + 1} / ${club.photos.length}`;
      document.querySelectorAll('.gallery-thumb').forEach((th, idx) => th.classList.toggle('active', idx === currentPhoto));
    }

    // --- Простая карта через ymaps3 + геокод ---
    async function initClubMap(address, title) {
      if (!address) return;
      const ymaps3 = window.ymaps3;
      if (!ymaps3) {
        console.warn('ymaps3 not available');
        return;
      }
      try {
        await ymaps3.ready;
      } catch (e) {
        console.warn('ymaps3.ready failed', e);
        return;
      }
      const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapMarker } = ymaps3;
      const coords = await geocodeAddress(address);
      if (!coords) return;
      const mapContainer = document.getElementById('clubMap');
      if (!mapContainer) return;
      const map = new YMap(mapContainer, { location: { center: coords, zoom: 16 } });
      map.addChild(new YMapDefaultSchemeLayer());
      map.addChild(new YMapDefaultFeaturesLayer());
      const el = document.createElement('div');
      el.className = 'club-marker';
      const label = document.createElement('div'); label.className='club-marker-label'; label.textContent = title || '';
      const dot = document.createElement('div'); dot.className='club-marker-dot';
      el.appendChild(label); el.appendChild(dot);
      map.addChild(new YMapMarker({ coordinates: coords }, el));
    }

    async function geocodeAddress(address) {
      if (!address) return null;
      const GEOCODE_API_KEY = '58c38b72-57f7-4946-bc13-a256d341281a';
      const url = `https://geocode-maps.yandex.ru/1.x/?format=json&geocode=${encodeURIComponent(address)}&apikey=${GEOCODE_API_KEY}&results=1`;
      try {
        const r = await fetch(url);
        if (!r.ok) return null;
        const json = await r.json();
        const fm = json?.response?.GeoObjectCollection?.featureMember;
        if (Array.isArray(fm) && fm.length) {
          const pos = fm[0].GeoObject?.Point?.pos;
          if (pos) {
            const [lng, lat] = pos.split(' ').map(Number);
            if (!Number.isNaN(lng) && !Number.isNaN(lat)) return [lng, lat];
          }
        }
        return null;
      } catch (err) {
        console.error('geocode failed', err);
        return null;
      }
    }

    // --- Утилиты ---
    function maskPhone(phone) {
      if (!phone) return '';
      if (phone.length <= 6) return phone;
      return phone.slice(0, 12) + '••-••';
    }
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    function escapeAttr(s){ return String(s||'').replaceAll('"','%22').replaceAll("'",'%27'); }

    // === Инициализация страницы: загрузить и отрисовать ===
    (async function initClubPage() {
      const mainContent = document.getElementById('mainContent');
      if (mainContent) mainContent.innerHTML = `<div style="padding:24px">Загрузка данных...</div>`;
      const apiClub = await fetchClubBySlug(slug);
      if (!apiClub) {
        if (mainContent) mainContent.innerHTML = `<div style="padding:24px;color:#900">Кружок с slug "${slug}" не найден.</div>`;
        document.title = 'Кружок не найден';
        return;
      }
      club = makeClubModel(apiClub);
      renderClub();
    })();
  </script>
</body>
</html>
