<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Загрузка... - Мапка</title>
  <meta name="description" content="Подробная информация о кружке: расписание, цены, отзывы и расположение на карте.">
  <link rel="icon" href="/favicon.ico" />
  
  <meta property="og:title" content="Мапка">
  <meta property="og:description" content="Найди кружок для ребёнка">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/og-image.jpg">

  <!-- Яндекс Карты API v3 -->
  <script src="https://api-maps.yandex.ru/v3/?apikey=58c38b72-57f7-4946-bc13-a256d341281a&lang=ru_RU"></script>

  <style>
    /* --- CORE STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #f9fafb;
      --bg-secondary: white;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --accent-color: #69AFDF;
      --accent-hover: #5b9bc5;
      --header-height: 72px;
      --container-width: 1100px; /* Чуть уже для читаемости текста */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 80px;
    }

    @media (min-width: 1024px) {
      body { padding-bottom: 0; }
    }

    /* --- HEADER --- */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      height: var(--header-height);
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      height: 100%;
      max-width: var(--container-width);
      margin: 0 auto;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 15px;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: #f3f4f6;
      color: var(--text-primary);
    }

    .header-title-scroll {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    .header-title-scroll.visible { opacity: 1; pointer-events: auto; }

    /* --- LAYOUT --- */
    .club-container {
      width: 100%;
      max-width: var(--container-width);
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
      align-items: start;
    }

    @media (min-width: 1024px) {
      .club-container {
        grid-template-columns: 2fr 1fr; /* 2/3 Content, 1/3 Sidebar */
        padding-top: 40px;
      }
    }

    /* --- MAIN COLUMN --- */
    .club-main {
      display: flex;
      flex-direction: column;
      gap: 32px;
      min-width: 0;
    }

    /* 1. Header Block (Title + Badges) */
    .header-block {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    .badge.category { background: var(--accent-color); color: white; }
    .badge.age { background: #e5e7eb; color: var(--text-secondary); }

    h1.main-title {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      margin: 0;
    }
    
    @media (min-width: 768px) { h1.main-title { font-size: 36px; } }

    .address-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 15px;
    }
    .address-row svg { flex-shrink: 0; margin-top: 2px; }

    /* 2. Gallery */
    .gallery-container {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      background: #e5e7eb;
      aspect-ratio: 16/10;
      user-select: none;
    }

    @media (min-width: 768px) { .gallery-container { aspect-ratio: 21/10; max-height: 500px; } }

    .gallery-track {
      display: flex;
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease-out;
    }

    .gallery-slide {
      min-width: 100%;
      height: 100%;
    }
    
    .gallery-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.9);
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
      transition: transform 0.2s;
    }
    .gallery-nav-btn:active { transform: translateY(-50%) scale(0.95); }
    .gallery-nav-btn.prev { left: 16px; }
    .gallery-nav-btn.next { right: 16px; }
    
    .gallery-dots {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      z-index: 10;
    }
    .gallery-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      transition: all 0.2s;
    }
    .gallery-dot.active { background: white; transform: scale(1.2); }

    /* 3. Price Block (Moved Above Description) */
    .price-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow-card);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--border-color);
    }
    
    .price-info h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 500; }
    .price-value { font-size: 28px; font-weight: 800; color: var(--text-primary); }
    .price-note { font-size: 14px; color: #10b981; font-weight: 500; background: #ecfdf5; padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 6px;}

    /* 4. Description Section */
    .section-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color);
    }

    .section-header { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
    .section-text { font-size: 16px; line-height: 1.6; color: #374151; white-space: pre-line; }

    /* 5. Social Buttons (Under Description) */
    .social-block {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
    }
    .social-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; }
    .social-grid { display: flex; gap: 12px; flex-wrap: wrap; }
    
    .social-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s;
      flex: 1;
      justify-content: center;
      min-width: 140px;
    }
    .social-btn:hover { transform: translateY(-2px); }
    .social-vk { background: #0077FF; color: white; }
    .social-tg { background: #24A1DE; color: white; }
    .social-wa { background: #25D366; color: white; }

    /* 6. Schedule (Improved Readability) */
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .schedule-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 12px;
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }
    .schedule-row:hover { border-color: var(--accent-color); background: #f0f9ff; }

    .schedule-day { font-weight: 700; color: var(--text-primary); font-size: 16px; display: flex; align-items: center; gap: 10px; }
    .schedule-day svg { color: var(--accent-color); }
    .schedule-time { font-family: 'Menlo', 'Monaco', monospace; font-size: 15px; color: #374151; background: white; padding: 4px 10px; border-radius: 6px; border: 1px solid #e5e5e5; }

    /* 7. Map */
    .map-wrapper {
      height: 320px;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #e5e7eb;
      position: relative;
    }
    
    .club-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
      transform: translate(-50%, -100%);
    }

    .club-marker-label {
      font-size: 12px;
      font-weight: 600;
      color: #111;
      background: white;
      padding: 4px 8px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      white-space: nowrap;
      margin-bottom: 4px;
    }

    .club-marker-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-color);
      box-shadow: 0 0 0 3px white, 0 4px 10px rgba(0,0,0,0.3);
    }

    /* --- SIDEBAR (RIGHT) - Desktop Only Actions --- */
    .sidebar-wrapper {
      position: relative;
      height: 100%;
    }
    
    .sidebar-sticky {
      position: sticky;
      top: 100px;
      background: white;
      padding: 24px;
      border-radius: 20px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .cta-btn {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s;
    }
    
    .btn-primary { background: var(--accent-color); color: white; box-shadow: 0 4px 12px rgba(105, 175, 223, 0.3); }
    .btn-primary:hover { transform: translateY(-2px); background: var(--accent-hover); }
    
    .btn-outline { background: white; border: 2px solid var(--bg-primary); color: var(--text-primary); }
    .btn-outline:hover { border-color: var(--accent-color); color: var(--accent-color); }

    /* --- MOBILE BOTTOM BAR --- */
    .mobile-bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    @media (min-width: 1024px) { .mobile-bottom-bar { display: none; } }

  </style>
</head>
<body>

  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
        <span>Назад</span>
      </a>
      <!-- Title appears here on scroll -->
      <div class="header-title-scroll" id="headerScrollTitle">Загрузка...</div>
      
      <button class="back-btn" style="border:none; background:none;" aria-label="Поделиться" onclick="alert('Ссылка скопирована!')">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
        </svg>
      </button>
    </div>
  </header>

  <div class="club-container" id="mainContainer">
     <!-- Content populated by JS -->
  </div>

  <!-- Mobile Actions -->
  <div class="mobile-bottom-bar" id="mobileBottomBar">
      <!-- Content populated by JS -->
  </div>

  <script>
    // --- API CONFIG ---
    // Улучшенная логика: если мы на localhost или в превью (blob/scf), пробуем localhost, но готовимся к ошибке
    const API_BASE = "http://localhost:8000/api";

    // --- UTILS ---
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    
    // Получаем slug
    const url = new URL(window.location.href);
    let slug = url.searchParams.get('slug');
    if (!slug) {
      const path = url.pathname.replace(/^\/+|\/+$/g, "");
      if (path && path !== "club.html" && path !== "index.html") slug = path;
    }

    let club = null;
    let currentPhotoIdx = 0;
    let showFullPhone = false;

    // --- DEMO DATA (Fallback) ---
    // Используется, если бэкенд недоступен, чтобы верстка не "падала"
    const DEMO_CLUB = {
        title: "Футбольная Академия 'Чемпион'",
        category: "Спорт",
        minAge: 5,
        maxAge: 16,
        price: 5500,
        priceNotes: "за 12 тренировок",
        address: "г. Москва, ул. Ленина, д. 42",
        phone: "+79991234567",
        description: "Приглашаем детей от 5 до 16 лет в нашу футбольную школу! \n\nМы предлагаем:\n• Профессиональный тренерский состав (лицензии UEFA)\n• Современные поля с искусственным покрытием\n• Участие в городских и областных турнирах\n• Летние спортивные лагеря\n\nНаша методика основана на развитии индивидуальных качеств игрока и командного взаимодействия. Первая тренировка - бесплатно!",
        tags: ["Футбол", "Спорт", "Команда", "ОФП"],
        photos: [
            "https://images.unsplash.com/photo-1517466787929-bc90951d0974?q=80&w=1200&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1543351611-58f69d7c1781?q=80&w=1200&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1579952363873-27f3bade9f55?q=80&w=1200&auto=format&fit=crop"
        ],
        schedules: [
            { day: "Понедельник", time: "17:00 - 18:30" },
            { day: "Среда", time: "17:00 - 18:30" },
            { day: "Пятница", time: "16:30 - 18:00" },
            { day: "Суббота", time: "10:00 - 11:30 (Игровой день)" }
        ],
        socialLinks: { vk: "https://vk.com", telegram: "https://t.me" },
        capacity: 15
    };

    // --- FETCH ---
    async function fetchClubData(slug) {
        // Если slug нет, сразу демо
        if (!slug) return DEMO_CLUB;

        try {
            // Пытаемся стучаться на бэкенд
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 2000); // Тайм-аут 2 сек

            const res = await fetch(`${API_BASE}/clubs`, { signal: controller.signal });
            clearTimeout(id);

            if (!res.ok) throw new Error("API Error");
            const list = await res.json();
            const found = list.find(c => String(c.slug) === String(slug) || String(c.id) === String(slug));
            
            if (found) return found;
            return DEMO_CLUB; // Если не нашли по слагу, но API ответил (странно, но вернем демо)

        } catch (e) {
            console.warn("Backend unavailable, using DEMO data for preview.", e);
            return DEMO_CLUB;
        }
    }

    // --- MODEL MAKER ---
    function normalizeClub(apiData) {
        const photos = apiData.image || apiData.photos 
            ? (Array.isArray(apiData.photos) ? apiData.photos : [apiData.image]) 
            : DEMO_CLUB.photos;
        
        // Ensure full URLs
        const normPhotos = photos.map(p => p.startsWith('/') ? location.origin + p : p);
        if (normPhotos.length === 0) normPhotos.push('https://via.placeholder.com/800x400');

        return {
            title: apiData.name || apiData.title || "Без названия",
            category: (apiData.tags && apiData.tags[0]) || "Кружок",
            minAge: apiData.minAge || 0,
            maxAge: apiData.maxAge || 18,
            price: apiData.price_cents ? Math.round(apiData.price_cents / 100) : (apiData.price || 0),
            priceNotes: apiData.price_note || apiData.priceNotes || "",
            address: apiData.location || apiData.address || "Адрес не указан",
            phone: apiData.phone || "",
            description: apiData.description || "",
            schedules: apiData.schedules || [],
            socialLinks: apiData.socialLinks || {},
            tags: apiData.tags || [],
            photos: normPhotos,
            webSite: apiData.webSite || ""
        };
    }

    // --- RENDER ---
    async function initPage() {
        const rawData = await fetchClubData(slug);
        club = normalizeClub(rawData);

        document.title = `${club.title} - Мапка`;
        const container = document.getElementById('mainContainer');
        const mobileBar = document.getElementById('mobileBottomBar');
        const headerTitle = document.getElementById('headerScrollTitle');

        if (headerTitle) headerTitle.textContent = club.title;

        // Formatted Values
        const priceStr = club.price > 0 ? `${club.price.toLocaleString('ru-RU')} ₽` : "Бесплатно";
        const ageStr = `${club.minAge} - ${club.maxAge} лет`;

        // 1. MAIN CONTENT HTML
        let html = `
            <div class="club-main">
                <!-- HEADER BLOCK: H1 & BADGES -->
                <div class="header-block">
                    <div class="badges">
                        <span class="badge category">${escapeHtml(club.category)}</span>
                        <span class="badge age">${ageStr}</span>
                    </div>
                    <h1 class="main-title">${escapeHtml(club.title)}</h1>
                    <div class="address-row">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>${escapeHtml(club.address)}</span>
                    </div>
                </div>

                <!-- GALLERY -->
                <div class="gallery-container" id="galleryContainer">
                    <div class="gallery-track" id="galleryTrack">
                        ${club.photos.map(src => `<div class="gallery-slide"><img src="${src}" alt="Фото"></div>`).join('')}
                    </div>
                    ${club.photos.length > 1 ? `
                        <button class="gallery-nav-btn prev" id="btnPrev"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <button class="gallery-nav-btn next" id="btnNext"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                        <div class="gallery-dots">
                            ${club.photos.map((_, i) => `<div class="gallery-dot ${i===0?'active':''}" data-idx="${i}"></div>`).join('')}
                        </div>
                    ` : ''}
                </div>

                <!-- PRICE BLOCK (ABOVE DESCRIPTION) -->
                <div class="price-card">
                    <div class="price-info">
                        <h3>Стоимость занятий</h3>
                        <div class="price-value">${priceStr}</div>
                        ${club.priceNotes ? `<div class="price-note">${escapeHtml(club.priceNotes)}</div>` : ''}
                    </div>
                    <!-- CTA Button Desktop Inline -->
                    <div class="desktop-only" style="display:none; @media(min-width:1024px){display:block}">
                       <!-- Can add quick action here if needed -->
                    </div>
                </div>

                <!-- DESCRIPTION (ABOUT) -->
                <div class="section-card">
                    <h2 class="section-header">О кружке</h2>
                    <div class="section-text">${escapeHtml(club.description)}</div>

                    <!-- SOCIAL LINKS (BELOW DESCRIPTION) -->
                    ${(club.socialLinks.vk || club.socialLinks.telegram || club.socialLinks.whatsapp) ? `
                        <div class="social-block">
                            <div class="social-title">Мы в соцсетях:</div>
                            <div class="social-grid">
                                ${club.socialLinks.vk ? `<a href="${club.socialLinks.vk}" target="_blank" class="social-btn social-vk"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.07 2H8.93C5.1 2 2 5.1 2 8.93v6.14C2 18.9 5.1 22 8.93 22h6.14c3.83 0 6.93-3.1 6.93-6.93V8.93C22 5.1 18.9 2 15.07 2zM18 13.5h-1.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5H18c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5z"/></svg> ВКонтакте</a>` : ''}
                                ${club.socialLinks.telegram ? `<a href="${club.socialLinks.telegram}" target="_blank" class="social-btn social-tg"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.665 3.717l-17.73 6.837c-1.21.486-1.203 1.161-.222 1.462l4.552 1.42l10.532-6.645c.498-.303.953-.14.579.192l-8.533 7.701l-.25 3.635c.34 0 .63-.166.875-.411l2.368-2.288l4.922 3.635c.907.5 1.56.242 1.783-.855l3.226-15.228c.328-1.536-.576-2.193-1.602-1.745z"/></svg> Telegram</a>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- SCHEDULE (READABLE LIST) -->
                <div class="section-card">
                    <h2 class="section-header">Расписание</h2>
                    <div class="schedule-list">
                        ${club.schedules.length ? club.schedules.map(s => `
                            <div class="schedule-row">
                                <div class="schedule-day">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    ${escapeHtml(s.day)}
                                </div>
                                <div class="schedule-time">${escapeHtml(s.time)}</div>
                            </div>
                        `).join('') : '<div class="section-text" style="color:#999">Расписание уточняйте по телефону</div>'}
                    </div>
                </div>

                <!-- MAP -->
                <div class="section-card" style="padding:0; overflow:hidden;">
                     <div class="map-wrapper" id="clubMap"></div>
                     <div style="padding:16px;">
                        <div style="font-weight:600; margin-bottom:4px;">Адрес:</div>
                        <div style="color:#555;">${escapeHtml(club.address)}</div>
                     </div>
                </div>
            </div>

            <!-- SIDEBAR (STICKY, DESKTOP ONLY) -->
            <div class="sidebar-wrapper">
                <div class="sidebar-sticky">
                    <div style="text-align:center; margin-bottom:12px;">
                        <div style="font-size:14px; color:#777;">Запись в группу</div>
                        <div style="font-weight:800; font-size:24px; color:var(--text-primary); margin-top:4px;">${club.phone ? maskPhone(club.phone) : ''}</div>
                    </div>
                    <button class="cta-btn btn-primary" onclick="togglePhone(this, '${club.phone}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                        Показать номер
                    </button>
                    <button class="cta-btn btn-outline">Написать сообщение</button>
                    <div style="font-size:12px; color:#999; text-align:center; line-height:1.4;">
                        Нажимаю кнопку, вы соглашаетесь с условиями обработки персональных данных
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;

        // 2. MOBILE ACTIONS HTML
        mobileBar.innerHTML = `
            <button class="cta-btn btn-primary" style="flex:1" onclick="togglePhone(this, '${club.phone}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                Позвонить
            </button>
            <button class="cta-btn btn-outline" style="width:auto; padding:12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
            </button>
        `;

        // 3. INIT LOGIC (Map, Gallery)
        initMap(club.address);
        initGallery();
        
        // Scroll listener for header title
        window.addEventListener('scroll', () => {
             const offset = window.scrollY;
             if (offset > 150) headerTitle.classList.add('visible');
             else headerTitle.classList.remove('visible');
        });
    }

    // --- GALLERY LOGIC (WITH SWIPE) ---
    function initGallery() {
        const track = document.getElementById('galleryTrack');
        const slides = document.querySelectorAll('.gallery-slide');
        const dots = document.querySelectorAll('.gallery-dot');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');

        if (slides.length <= 1) return;

        function updateSlide(idx) {
            currentPhotoIdx = idx;
            const offset = -idx * 100;
            track.style.transform = `translateX(${offset}%)`;
            dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        }

        // Click Events
        if(btnPrev) btnPrev.addEventListener('click', () => updateSlide((currentPhotoIdx - 1 + slides.length) % slides.length));
        if(btnNext) btnNext.addEventListener('click', () => updateSlide((currentPhotoIdx + 1) % slides.length));
        dots.forEach(d => d.addEventListener('click', () => updateSlide(Number(d.dataset.idx))));

        // Swipe Events
        let startX = 0;
        let isDragging = false;

        track.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
        }, {passive: true});

        track.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
        }, {passive: true});

        track.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            const endX = e.changedTouches[0].clientX;
            const diff = startX - endX;

            if (Math.abs(diff) > 50) { // Threshold 50px
                if (diff > 0) {
                    // Swipe Left -> Next
                    updateSlide((currentPhotoIdx + 1) % slides.length);
                } else {
                    // Swipe Right -> Prev
                    updateSlide((currentPhotoIdx - 1 + slides.length) % slides.length);
                }
            }
            isDragging = false;
        });
    }

    // --- MAP LOGIC ---
    async function initMap(address) {
        if (!address || !window.ymaps3) return;
        try {
            await ymaps3.ready;
            const { YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer, YMapMarker } = ymaps3;

            // Geocode (Simple fetch to Yandex)
            // Note: In production use a backend proxy to hide API key if needed, or restricted HTTP referrer
            const geocodeUrl = `https://geocode-maps.yandex.ru/1.x/?format=json&apikey=58c38b72-57f7-4946-bc13-a256d341281a&geocode=${encodeURIComponent(address)}`;
            
            const res = await fetch(geocodeUrl);
            const data = await res.json();
            const pos = data.response.GeoObjectCollection.featureMember[0]?.GeoObject?.Point?.pos;
            
            if (!pos) return;
            const [lng, lat] = pos.split(' ').map(Number);

            const mapContainer = document.getElementById('clubMap');
            mapContainer.innerHTML = '';
            
            const map = new YMap(mapContainer, { location: { center: [lng, lat], zoom: 15 } });
            map.addChild(new YMapDefaultSchemeLayer());
            map.addChild(new YMapDefaultFeaturesLayer());

            const markerEl = document.createElement('div');
            markerEl.className = 'club-marker';
            markerEl.innerHTML = `<div class="club-marker-label">${club.title}</div><div class="club-marker-dot"></div>`;
            
            map.addChild(new YMapMarker({ coordinates: [lng, lat] }, markerEl));

        } catch (e) {
            console.warn("Map init failed", e);
        }
    }

    // --- UTILS ---
    window.togglePhone = function(btn, phone) {
        if (!phone) return;
        showFullPhone = !showFullPhone;
        const text = showFullPhone ? phone : "Показать номер";
        
        // Update button text logic
        // Simple implementation: replace inner text node if mixed with svg
        // For now, just simplistic
        if (showFullPhone) {
             btn.innerHTML = `<span style="font-size:18px;">${phone}</span>`;
             window.location.href = `tel:${phone}`;
        } else {
             btn.innerHTML = `Показать номер`; 
             // Restore SVG icon if needed, simplistic reset
             window.location.reload(); // Reset state easiest for demo or re-render btn
        }
    };

    function maskPhone(phone) {
        if (!phone) return "";
        if (phone.length < 10) return phone;
        return phone.substr(0, 8) + "••-••";
    }

    // START
    initPage();

  </script>
</body>
</html>